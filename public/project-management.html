<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSEC SA Project Management</title>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #1a1a1a; color: #e0e0e0; }
        .container { max-width: 1200px; margin: 0 auto; background: #121212; padding: 20px; border-radius: 12px; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #4a9eff; position: relative; }
        .header h1 { color: #4a9eff; margin: 0; font-size: 2rem; }
        .user-info { position: absolute; top: 20px; right: 20px; font-size: 0.9rem; }
        .logout-btn { background: #dc2626; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
        
        .section { background: #1e1e1e; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        
        /* Project Selection Bar */
        .project-selection-bar { 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            background: #1e1e1e; 
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 20px; 
            border: 1px solid #333; 
        }
        .project-selection-bar label { 
            font-weight: 600; 
            color: #4a9eff; 
        }
        .project-selection-bar select { 
            flex: 1; 
            max-width: 400px; 
        }
        
        /* Save Bar */
        .save-bar { 
            background: #1e3d29; 
            padding: 15px; 
            margin: -20px -20px 20px -20px; 
            border-radius: 8px 8px 0 0; 
            display: none; 
            align-items: center; 
            justify-content: space-between; 
            border: 1px solid #16a34a; 
        }
        .save-bar.show { display: flex; }
        .save-bar-text { color: #4ade80; font-weight: 600; }
        
        /* Tabs */
        .tabs { display: flex; background: #2a2a2a; border-radius: 8px; margin-bottom: 20px; }
        .tab { 
            flex: 1; 
            padding: 12px 20px; 
            background: transparent; 
            border: none; 
            color: #888; 
            cursor: pointer; 
            font-weight: 600; 
            border-right: 1px solid #333; 
        }
        .tab:last-child { border-right: none; }
        .tab.active { background: #4a9eff; color: white; }
        .tab:hover:not(.active) { background: #333; color: #e0e0e0; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Form Elements */
        input, select, textarea { 
            width: 100%; 
            padding: 10px; 
            border: 2px solid #404040; 
            border-radius: 6px; 
            background: #2a2a2a; 
            color: #e0e0e0; 
            font-size: 14px; 
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #4a9eff; 
            background: #333; 
        }
        
        /* Buttons */
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.2s ease; 
        }
        .btn-primary { background: #4a9eff; color: white; }
        .btn-primary:hover { background: #3a8eef; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover { background: #15803d; }
        .btn-secondary { background: #404040; color: white; }
        .btn-secondary:hover { background: #525252; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-sm { padding: 6px 12px; font-size: 0.875rem; }
        .btn-icon { 
            width: 32px; 
            height: 32px; 
            padding: 0; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 18px; 
        }
        
        /* Tables */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        th, td { 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid #333; 
        }
        th { 
            background: #2a2a2a; 
            color: #4a9eff; 
            font-weight: 600; 
        }
        
        /* Stats Grid */
        .stats { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        .stat { 
            background: #2a2a2a; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .stat h4 { 
            margin: 0 0 10px; 
            color: #888; 
            font-size: 0.875rem; 
            font-weight: normal; 
        }
        .stat .value { 
            color: #4a9eff; 
            font-size: 1.5rem; 
            font-weight: 600; 
        }
        
        /* Toolbar */
        .toolbar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            gap: 10px; 
        }
        .toolbar-left { 
            display: flex; 
            gap: 10px; 
            flex: 1; 
        }
        .search-box { 
            max-width: 300px; 
        }
        
        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.7); 
            animation: fadeIn 0.3s ease; 
        }
        .modal.show { display: block; }
        .modal-content { 
            background: #1e1e1e; 
            margin: 50px auto; 
            padding: 30px; 
            border: 2px solid #4a9eff; 
            width: 90%; 
            max-width: 900px; 
            border-radius: 12px; 
            max-height: 90vh; 
            overflow-y: auto; 
            position: relative; 
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 2px solid #333; 
        }
        .modal-title { 
            color: #4a9eff; 
            font-size: 1.5rem; 
            margin: 0; 
        }
        .close { 
            color: #888; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: color 0.3s; 
            background: none; 
            border: none; 
        }
        .close:hover { color: #f87171; }
        
        /* Form Grid */
        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        .form-group.full-width { 
            grid-column: span 2; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            color: #4a9eff; 
            font-size: 0.9rem; 
        }
        .required { color: #f87171; }
        textarea { 
            resize: vertical; 
            min-height: 80px; 
        }
        
        /* Contact Section */
        .contact-section { 
            background: #2a2a2a; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
        }
        .contact-section h4 { 
            color: #4a9eff; 
            margin-top: 0; 
        }
        
        /* Bid Items Selection */
        .bid-items-selection { 
            margin-top: 20px; 
            padding-top: 20px; 
            border-top: 2px solid #333; 
        }
        .bid-items-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .selected-count { 
            background: #16a34a; 
            color: white; 
            padding: 5px 10px; 
            border-radius: 20px; 
            font-size: 0.875rem; 
        }
        
        /* Bid Items List */
        .bid-items-container { 
            max-height: 400px; 
            overflow-y: auto; 
            border: 1px solid #333; 
            border-radius: 8px; 
            padding: 10px; 
        }
        .bid-item-row { 
            display: grid; 
            grid-template-columns: 40px 100px 1fr 100px 120px 120px 120px; 
            gap: 10px; 
            align-items: center; 
            padding: 10px; 
            background: #2a2a2a; 
            border-radius: 6px; 
            margin-bottom: 8px; 
        }
        .bid-item-row.selected { 
            background: #1e3d29; 
            border: 1px solid #16a34a; 
        }
        .bid-item-row input[type="checkbox"] { 
            width: auto; 
        }
        .bid-item-row input[type="number"] { 
            padding: 6px; 
            font-size: 0.875rem; 
        }
        .item-info { 
            display: flex; 
            flex-direction: column; 
        }
        .item-code { 
            color: #4a9eff; 
            font-weight: 600; 
        }
        .item-name { 
            font-size: 0.875rem; 
            color: #888; 
        }
        
        /* Modal Footer */
        .modal-footer { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 20px; 
            padding-top: 20px; 
            border-top: 2px solid #333; 
        }
        .footer-info { 
            color: #888; 
            font-size: 0.875rem; 
        }
        .footer-actions { 
            display: flex; 
            gap: 10px; 
        }
        
        /* Message */
        .message { 
            padding: 15px; 
            margin: 20px 0; 
            border-radius: 8px; 
            text-align: center; 
            animation: fadeIn 0.3s ease; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        .message.success { background: #16a34a; color: white; }
        .message.error { background: #dc2626; color: white; }
        .message.info { background: #4a9eff; color: white; }
        
        /* Category Filter Chips */
        .category-filters { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin-bottom: 15px; 
        }
        .category-chip { 
            padding: 6px 12px; 
            background: #2a2a2a; 
            border: 1px solid #333; 
            border-radius: 20px; 
            cursor: pointer; 
            font-size: 0.875rem; 
            transition: all 0.2s; 
        }
        .category-chip:hover { 
            background: #333; 
            border-color: #4a9eff; 
        }
        .category-chip.active { 
            background: #4a9eff; 
            color: white; 
            border-color: #4a9eff; 
        }
        
        /* Hidden */
        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            .stats { grid-template-columns: repeat(2, 1fr); }
            .toolbar { flex-direction: column; align-items: stretch; }
            .toolbar-left { flex-direction: column; }
            .form-grid { grid-template-columns: 1fr; }
            .form-group.full-width { grid-column: span 1; }
            .bid-item-row { 
                grid-template-columns: 1fr; 
                gap: 5px; 
            }
        }
    </style>
    <script src="auth-helper.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Project Management</h1>
            <div class="user-info">
                <span id="userDisplay">Loading...</span>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </div>
        
        <div class="project-selection-bar">
            <label>Project:</label>
            <select id="project">
                <option value="">-- Select Project --</option>
            </select>
            <button class="btn btn-primary" onclick="openNewProjectModal()">
                + Add New Project
            </button>
        </div>
        
        <div id="mainContent" class="section hidden">
            <!-- Save Bar -->
            <div id="saveBar" class="save-bar">
                <div class="save-bar-text"><span id="changeCount">0</span> unsaved changes</div>
                <div>
                    <button class="btn" onclick="discardChanges()">Discard</button>
                    <button class="btn btn-success" onclick="saveAllChanges()">Save All</button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('bid-items')">Project Bid Items</button>
                <button class="tab" onclick="switchTab('installed')">Installed Quantities</button>
                <button class="tab" onclick="switchTab('pay-app')">Pay Application</button>
            </div>
            
            <!-- Tab content remains the same as original... -->
            <div id="bid-items" class="tab-content active">
                <!-- Existing bid items tab content -->
            </div>
            
            <div id="installed" class="tab-content">
                <!-- Existing installed tab content -->
            </div>
            
            <div id="pay-app" class="tab-content">
                <!-- Existing pay app tab content -->
            </div>
        </div>
        
        <div id="messageContainer"></div>
    </div>
    
    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Project</h2>
                <button class="close" onclick="closeNewProjectModal()">&times;</button>
            </div>
            
            <form id="newProjectForm">
                <!-- Project Basic Information -->
                <div class="form-grid">
                    <div class="form-group">
                        <label for="newProjectContractor">General Contractor <span class="required">*</span></label>
                        <select id="newProjectContractor" required>
                            <option value="">-- Select Contractor --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="newProjectCSJ">CSJ Number</label>
                        <input type="text" id="newProjectCSJ" placeholder="e.g., 0123-45-678">
                    </div>
                    
                    <div class="form-group">
                        <label for="newProjectLocation">Site Location <span class="required">*</span></label>
                        <input type="text" id="newProjectLocation" required placeholder="e.g., IH-35 at FM 1234">
                    </div>
                    
                    <div class="form-group">
                        <label for="newProjectCounty">County <span class="required">*</span></label>
                        <input type="text" id="newProjectCounty" required placeholder="e.g., Bexar">
                    </div>
                    
                    <div class="form-group">
                        <label for="newProjectName">Project Name</label>
                        <input type="text" id="newProjectName" placeholder="Auto-generated or enter custom name">
                    </div>
                    
                    <div class="form-group">
                        <label for="newProjectCode">Project Code</label>
                        <input type="text" id="newProjectCode" placeholder="Optional project code">
                    </div>
                    
                    <div class="form-group">
                        <label for="newProjectRetainage">Retainage (%)</label>
                        <input type="number" id="newProjectRetainage" min="0" max="100" step="0.1" placeholder="10">
                    </div>
                    
                    <div class="form-group">
                        <label for="newProjectStatus">Status</label>
                        <select id="newProjectStatus">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <!-- Project Manager Contact -->
                <div class="contact-section">
                    <h4>Project Manager</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="pmName">Name</label>
                            <input type="text" id="pmName" placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label for="pmEmail">Email</label>
                            <input type="email" id="pmEmail" placeholder="john.doe@company.com">
                        </div>
                        <div class="form-group">
                            <label for="pmPhone">Phone</label>
                            <input type="tel" id="pmPhone" placeholder="(210) 555-1234">
                        </div>
                        <div class="form-group">
                            <label for="pmMobile">Mobile</label>
                            <input type="tel" id="pmMobile" placeholder="(210) 555-5678">
                        </div>
                    </div>
                </div>
                
                <!-- Superintendent Contact -->
                <div class="contact-section">
                    <h4>Superintendent</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="superName">Name</label>
                            <input type="text" id="superName" placeholder="Jane Smith">
                        </div>
                        <div class="form-group">
                            <label for="superEmail">Email</label>
                            <input type="email" id="superEmail" placeholder="jane.smith@company.com">
                        </div>
                        <div class="form-group">
                            <label for="superPhone">Phone</label>
                            <input type="tel" id="superPhone" placeholder="(210) 555-2345">
                        </div>
                        <div class="form-group">
                            <label for="superMobile">Mobile</label>
                            <input type="tel" id="superMobile" placeholder="(210) 555-6789">
                        </div>
                    </div>
                </div>
                
                <!-- Accounts Payable Contact -->
                <div class="contact-section">
                    <h4>Accounts Payable</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="apName">Contact Name</label>
                            <input type="text" id="apName" placeholder="Accounts Payable Department">
                        </div>
                        <div class="form-group">
                            <label for="apEmail">Email</label>
                            <input type="email" id="apEmail" placeholder="ap@company.com">
                        </div>
                        <div class="form-group">
                            <label for="apPhone">Phone</label>
                            <input type="tel" id="apPhone" placeholder="(210) 555-3456">
                        </div>
                        <div class="form-group">
                            <label for="apFax">Fax</label>
                            <input type="tel" id="apFax" placeholder="(210) 555-3457">
                        </div>
                    </div>
                </div>
                
                <!-- Project Notes -->
                <div class="form-group full-width">
                    <label for="newProjectNotes">Project Notes</label>
                    <textarea id="newProjectNotes" rows="3" placeholder="Additional notes about this project..."></textarea>
                </div>
                
                <!-- Bid Items Selection -->
                <div class="bid-items-selection">
                    <div class="bid-items-header">
                        <h4>Select Bid Items for Project</h4>
                        <span class="selected-count" id="selectedItemsCount">0 items selected</span>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="toolbar">
                        <input type="text" id="bidItemSearch" class="search-box" placeholder="Search bid items...">
                        <select id="bidItemCategoryFilter">
                            <option value="">All Categories</option>
                            <option value="CLEARING">CLEARING</option>
                            <option value="DEMOLITION">DEMOLITION</option>
                            <option value="EARTHWORK">EARTHWORK</option>
                            <option value="EROSION CONTROL">EROSION CONTROL</option>
                            <option value="LANDSCAPING">LANDSCAPING</option>
                            <option value="MASONRY">MASONRY</option>
                            <option value="MISC METALS">MISC METALS</option>
                            <option value="PAINTING">PAINTING</option>
                            <option value="PAVING">PAVING</option>
                            <option value="SITE CONCRETE">SITE CONCRETE</option>
                            <option value="SPECIALTIES">SPECIALTIES</option>
                            <option value="STORM DRAINAGE">STORM DRAINAGE</option>
                            <option value="STRUCTURES">STRUCTURES</option>
                            <option value="TRAFFIC">TRAFFIC</option>
                            <option value="UTILITIES">UTILITIES</option>
                            <option value="WATERWORKS">WATERWORKS</option>
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="selectAllVisible()">Select All Visible</button>
                        <button type="button" class="btn btn-secondary" onclick="clearAllSelections()">Clear All</button>
                    </div>
                    
                    <!-- Bid Items List -->
                    <div class="bid-items-container" id="bidItemsList">
                        <!-- Bid items will be loaded dynamically -->
                    </div>
                </div>
            </form>
            
            <div class="modal-footer">
                <div class="footer-info">
                    <span id="totalSelectedValue">Total Contract Value: $0.00</span>
                </div>
                <div class="footer-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeNewProjectModal()">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveNewProject()">Create Project</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let allBidItems = [];
        let contractors = [];
        let selectedBidItems = new Map();
        let currentProjectData = {};
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthenticated = await AuthHelper.init({
                onAuthenticated: function(userInfo) {
                    document.getElementById('userDisplay').textContent = userInfo.name + ' (' + userInfo.role + ')';
                    initialize();
                }
            });
            
            if (!isAuthenticated) {
                return;
            }
        });
        
        async function initialize() {
            // Load data in parallel for better performance
            const promises = [
                loadProjects(),
                loadContractors(),
                loadBidItems()
            ];
            
            await Promise.all(promises);
            setupEventListeners();
        }
        
        // Load projects for dropdown
        async function loadProjects() {
            try {
                const projects = await AuthHelper.apiCall('api/projects');
                const select = document.getElementById('project');
                
                // Ensure projects is an array
                const projectList = Array.isArray(projects) ? projects : [];
                
                select.innerHTML = '<option value="">-- Select Project --</option>';
                projectList.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading projects:', error);
                showMessage('Error loading projects', 'error');
            }
        }
        
        // Load contractors for dropdown
        async function loadContractors() {
            try {
                const response = await AuthHelper.apiCall('api/general-contractors');
                // Ensure we have an array
                contractors = Array.isArray(response) ? response : [];
                
                const select = document.getElementById('newProjectContractor');
                
                select.innerHTML = '<option value="">-- Select Contractor --</option>';
                contractors.forEach(contractor => {
                    if (contractor.is_active !== false) {
                        const option = document.createElement('option');
                        option.value = contractor.id;
                        option.textContent = contractor.name;
                        select.appendChild(option);
                    }
                });
                
                return contractors;
            } catch (error) {
                console.error('Error loading contractors:', error);
                showMessage('Error loading contractors', 'error');
                contractors = [];
                return [];
            }
        }
        
        // Load all bid items
        async function loadBidItems() {
            try {
                const response = await AuthHelper.apiCall('api/bid-items');
                // Ensure we have an array
                allBidItems = Array.isArray(response) ? response : [];
                console.log(`Loaded ${allBidItems.length} bid items`);
                return allBidItems;
            } catch (error) {
                console.error('Error loading bid items:', error);
                showMessage('Error loading bid items', 'error');
                allBidItems = [];
                return [];
            }
        }
        
        // Open new project modal
        async function openNewProjectModal() {
            // Ensure bid items are loaded before opening
            if (allBidItems.length === 0) {
                await loadBidItems();
            }
            document.getElementById('newProjectModal').classList.add('show');
            renderBidItemsList();
        }
        
        // Close new project modal
        function closeNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('show');
            document.getElementById('newProjectForm').reset();
            selectedBidItems.clear();
            updateSelectedCount();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Project selection
            document.getElementById('project').addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('mainContent').classList.remove('hidden');
                    // Load project data (existing functionality)
                } else {
                    document.getElementById('mainContent').classList.add('hidden');
                }
            });
            
            // Auto-generate project name
            document.getElementById('newProjectContractor').addEventListener('change', generateProjectName);
            document.getElementById('newProjectLocation').addEventListener('input', generateProjectName);
            document.getElementById('newProjectCounty').addEventListener('input', generateProjectName);
            
            // Bid items search and filter
            document.getElementById('bidItemSearch').addEventListener('input', renderBidItemsList);
            document.getElementById('bidItemCategoryFilter').addEventListener('change', renderBidItemsList);
        }
        
        // Generate project name
        function generateProjectName() {
            const contractorId = document.getElementById('newProjectContractor').value;
            const location = document.getElementById('newProjectLocation').value;
            const county = document.getElementById('newProjectCounty').value;
            const nameField = document.getElementById('newProjectName');
            
            // Only auto-generate if name field is empty or was previously auto-generated
            if (contractorId && location && county && !nameField.dataset.manual) {
                const contractor = contractors.find(c => c.id === contractorId);
                if (contractor) {
                    const generatedName = `${contractor.name.toUpperCase()} ${location.toUpperCase()} ${county.toUpperCase()}`;
                    nameField.value = generatedName;
                    return generatedName;
                }
            }
            
            return nameField.value || '';
        }
        
        // Mark name field as manually edited
        const nameField = document.getElementById('newProjectName');
        if (nameField) {
            nameField.addEventListener('input', function() {
                if (this.value) {
                    this.dataset.manual = 'true';
                } else {
                    delete this.dataset.manual;
                }
            });
        }
        
        // Render bid items list in modal
        function renderBidItemsList() {
            const container = document.getElementById('bidItemsList');
            const searchTerm = document.getElementById('bidItemSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('bidItemCategoryFilter').value;
            
            // Ensure allBidItems is an array
            if (!Array.isArray(allBidItems)) {
                console.error('Bid items not loaded properly');
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f87171;">Error loading bid items. Please refresh the page.</div>';
                return;
            }
            
            let filteredItems = [...allBidItems]; // Create a copy to avoid mutations
            
            // Apply search filter
            if (searchTerm) {
                filteredItems = filteredItems.filter(item => 
                    item.item_code && item.item_code.toLowerCase().includes(searchTerm) ||
                    item.item_name && item.item_name.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply category filter
            if (categoryFilter) {
                filteredItems = filteredItems.filter(item => item.category === categoryFilter);
            }
            
            // Clear container
            container.innerHTML = '';
            
            if (filteredItems.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No bid items found</div>';
                return;
            }
            
            // Render items
            filteredItems.forEach(item => {
                const row = document.createElement('div');
                row.className = 'bid-item-row';
                if (selectedBidItems.has(item.id)) {
                    row.classList.add('selected');
                }
                
                const isChecked = selectedBidItems.has(item.id);
                const savedData = selectedBidItems.get(item.id) || {};
                
                row.innerHTML = `
                    <input type="checkbox" 
                           data-item-id="${item.id}" 
                           ${isChecked ? 'checked' : ''} 
                           onchange="toggleBidItem('${item.id}')">
                    <div class="item-info">
                        <span class="item-code">${item.item_code || 'N/A'}</span>
                    </div>
                    <div class="item-info">
                        <span class="item-name">${item.item_name || 'Unnamed Item'}</span>
                        <span style="color: #666; font-size: 0.75rem;">${item.category || 'Uncategorized'}</span>
                    </div>
                    <input type="text" 
                           placeholder="Unit" 
                           value="${savedData.unit || item.default_unit || 'EA'}"
                           onchange="updateBidItemData('${item.id}', 'unit', this.value)"
                           ${!isChecked ? 'disabled' : ''}>
                    <input type="number" 
                           placeholder="Contract Qty" 
                           value="${savedData.contract_quantity || ''}"
                           step="0.01"
                           onchange="updateBidItemData('${item.id}', 'contract_quantity', this.value)"
                           ${!isChecked ? 'disabled' : ''}>
                    <input type="number" 
                           placeholder="Rate ($)" 
                           value="${savedData.rate || ''}"
                           step="0.01"
                           onchange="updateBidItemData('${item.id}', 'rate', this.value)"
                           ${!isChecked ? 'disabled' : ''}>
                    <input type="number" 
                           placeholder="Material ($)" 
                           value="${savedData.material_cost || item.material_cost || ''}"
                           step="0.01"
                           onchange="updateBidItemData('${item.id}', 'material_cost', this.value)"
                           ${!isChecked ? 'disabled' : ''}>
                `;
                
                container.appendChild(row);
            });
        }
        
        // Toggle bid item selection
        function toggleBidItem(itemId) {
            // Ensure allBidItems is an array
            if (!Array.isArray(allBidItems)) {
                console.error('Bid items not loaded');
                return;
            }
            
            const item = allBidItems.find(i => i.id === itemId);
            if (!item) {
                console.error('Item not found:', itemId);
                return;
            }
            
            if (selectedBidItems.has(itemId)) {
                selectedBidItems.delete(itemId);
            } else {
                selectedBidItems.set(itemId, {
                    bid_item_id: itemId,
                    unit: item.default_unit || 'EA',
                    rate: 0,
                    material_cost: item.material_cost || 0,
                    contract_quantity: 0
                });
            }
            
            updateSelectedCount();
            renderBidItemsList();
        }
        
        // Update bid item data
        function updateBidItemData(itemId, field, value) {
            if (!selectedBidItems.has(itemId)) return;
            
            const data = selectedBidItems.get(itemId);
            if (field === 'unit') {
                data[field] = value;
            } else {
                data[field] = parseFloat(value) || 0;
            }
            
            selectedBidItems.set(itemId, data);
            updateSelectedCount();
        }
        
        // Update selected count and total value
        function updateSelectedCount() {
            const count = selectedBidItems.size;
            document.getElementById('selectedItemsCount').textContent = `${count} items selected`;
            
            // Calculate total contract value
            let totalValue = 0;
            selectedBidItems.forEach(data => {
                totalValue += (data.contract_quantity || 0) * (data.rate || 0);
            });
            
            document.getElementById('totalSelectedValue').textContent = `Total Contract Value: $${totalValue.toFixed(2)}`;
        }
        
        // Select all visible items
        function selectAllVisible() {
            const checkboxes = document.querySelectorAll('#bidItemsList input[type="checkbox"]:not(:checked)');
            checkboxes.forEach(cb => {
                cb.click();
            });
        }
        
        // Clear all selections
        function clearAllSelections() {
            selectedBidItems.clear();
            updateSelectedCount();
            renderBidItemsList();
        }
        
        // Save new project
        async function saveNewProject() {
            try {
                // Validate required fields
                const contractorId = document.getElementById('newProjectContractor').value;
                const location = document.getElementById('newProjectLocation').value;
                const county = document.getElementById('newProjectCounty').value;
                
                if (!contractorId || !location || !county) {
                    showMessage('Please fill in all required fields', 'error');
                    return;
                }
                
                // Prepare project data
                const projectName = document.getElementById('newProjectName').value || generateProjectName();
                
                const projectData = {
                    name: projectName,
                    project_code: document.getElementById('newProjectCode').value || null,
                    general_contractor_id: contractorId,
                    site_location: location,
                    county: county,
                    retainage: parseFloat(document.getElementById('newProjectRetainage').value) || 10,
                    active: document.getElementById('newProjectStatus').value === 'true'
                };
                
                // Create project
                const newProject = await AuthHelper.apiCall('api/projects', {
                    method: 'POST',
                    body: JSON.stringify(projectData)
                });
                
                if (!newProject || !newProject.id) {
                    throw new Error('Failed to create project');
                }
                
                // Save contact information as notes (temporary - you may want to create separate tables)
                const contactNotes = {
                    project_manager: {
                        name: document.getElementById('pmName').value,
                        email: document.getElementById('pmEmail').value,
                        phone: document.getElementById('pmPhone').value,
                        mobile: document.getElementById('pmMobile').value
                    },
                    superintendent: {
                        name: document.getElementById('superName').value,
                        email: document.getElementById('superEmail').value,
                        phone: document.getElementById('superPhone').value,
                        mobile: document.getElementById('superMobile').value
                    },
                    accounts_payable: {
                        name: document.getElementById('apName').value,
                        email: document.getElementById('apEmail').value,
                        phone: document.getElementById('apPhone').value,
                        fax: document.getElementById('apFax').value
                    },
                    notes: document.getElementById('newProjectNotes').value
                };
                
                // Add selected bid items to project
                let addedCount = 0;
                for (const [itemId, data] of selectedBidItems) {
                    try {
                        await AuthHelper.apiCall('api/project-bid-items', {
                            method: 'POST',
                            body: JSON.stringify({
                                project_id: newProject.id,
                                bid_item_id: itemId,
                                unit: data.unit,
                                rate: data.rate,
                                material_cost: data.material_cost,
                                contract_quantity: data.contract_quantity,
                                notes: JSON.stringify(contactNotes) // Store contacts in first item's notes temporarily
                            })
                        });
                        addedCount++;
                        
                        // Clear contact notes after first item
                        contactNotes = null;
                    } catch (error) {
                        console.error(`Failed to add bid item ${itemId}:`, error);
                    }
                }
                
                showMessage(`Project created successfully with ${addedCount} bid items!`, 'success');
                
                // Refresh projects list
                await loadProjects();
                
                // Select the new project
                document.getElementById('project').value = newProject.id;
                document.getElementById('project').dispatchEvent(new Event('change'));
                
                // Close modal
                closeNewProjectModal();
                
            } catch (error) {
                console.error('Error creating project:', error);
                showMessage('Error creating project: ' + error.message, 'error');
            }
        }
        
        // Show message
        function showMessage(text, type) {
            const container = document.getElementById('messageContainer');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            container.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 5000);
        }
        
        // Logout handler
        function handleLogout() {
            AuthHelper.logout();
        }
        
        // Tab switching (existing functionality)
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
    </script>
</body>
</html>

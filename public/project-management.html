<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSEC SA Project Management</title>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #1a1a1a; color: #e0e0e0; }
        .container { max-width: 1200px; margin: 0 auto; background: #121212; padding: 20px; border-radius: 12px; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #4a9eff; }
        .header h1 { color: #4a9eff; margin: 0; font-size: 2rem; }
        .user-info { position: absolute; top: 20px; right: 20px; font-size: 0.9rem; }
        .logout-btn { background: #dc2626; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
        
        .section { background: #1e1e1e; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        
        /* Save Bar */
        .save-bar { background: #1e3d29; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0; 
                   display: none; align-items: center; justify-content: space-between; border: 1px solid #16a34a; }
        .save-bar.show { display: flex; }
        .save-bar-text { color: #4ade80; font-weight: 600; }
        
        /* Tabs */
        .tabs { display: flex; background: #2a2a2a; border-radius: 8px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 12px 20px; background: transparent; border: none; color: #888; cursor: pointer; 
               font-weight: 600; border-right: 1px solid #333; }
        .tab:last-child { border-right: none; }
        .tab.active { background: #4a9eff; color: white; }
        .tab:hover:not(.active) { background: #333; color: #e0e0e0; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Form Elements */
        input, select { width: 100%; padding: 10px; border: 2px solid #404040; border-radius: 6px; 
                       background: #2a2a2a; color: #e0e0e0; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: #4a9eff; background: #333; }
        
        /* Editable Fields */
        .editable { background: transparent; border: 1px solid transparent; padding: 4px 8px; border-radius: 4px; 
                   transition: all 0.2s ease; font-size: 13px; }
        .editable:hover { background: #2a2a2a; border-color: #404040; }
        .editable:focus { background: #333; border-color: #4a9eff; box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2); }
        .editable.changed { background: rgba(74, 158, 255, 0.1); border-color: #4a9eff; }
        
        /* Buttons */
        .btn { background: #4a9eff; color: white; border: none; padding: 10px 20px; border-radius: 6px; 
               cursor: pointer; font-weight: 600; }
        .btn:hover { background: #357abd; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; background: #1e1e1e; font-size: 13px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #404040; }
        th { background: #242424; color: #4a9eff; font-weight: 600; text-transform: uppercase; font-size: 11px; }
        tr:hover { background: #242424; }
        tr.modified { background: rgba(74, 158, 255, 0.1); border-left: 3px solid #4a9eff; }
        
        .table-container { overflow-x: auto; border: 1px solid #404040; border-radius: 8px; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat { background: #242424; padding: 15px; border-radius: 8px; border: 1px solid #404040; }
        .stat h4 { margin: 0 0 8px 0; color: #4a9eff; font-size: 12px; text-transform: uppercase; }
        .stat .value { font-size: 20px; font-weight: bold; color: #e0e0e0; }
        
        .alert { padding: 12px; border-radius: 6px; margin-bottom: 15px; }
        .alert-success { background: #1e3d29; color: #4ade80; border: 1px solid #16a34a; }
        .alert-error { background: #3d1e1e; color: #f87171; border: 1px solid #dc2626; }
        .hidden { display: none !important; }
        
        /* Progress bar */
        .progress { background: #333; border-radius: 4px; height: 18px; position: relative; overflow: hidden; }
        .progress-fill { background: #28a745; height: 100%; transition: width 0.3s; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                        color: white; font-size: 10px; font-weight: bold; }
        
        /* Status colors */
        .status-complete { color: #4ade80; }
        .status-partial { color: #fbbf24; }
        .status-pending { color: #f87171; }
        .over-billed { color: #f87171; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Project Management</h1>
            <div class="user-info">
                <span id="userDisplay">Loading...</span>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </div>
        
        <div class="section">
            <label>Project:</label>
            <select id="project">
                <option value="">-- Select Project --</option>
            </select>
        </div>
        
        <div id="mainContent" class="section hidden">
            <!-- Save Bar -->
            <div id="saveBar" class="save-bar">
                <div class="save-bar-text"><span id="changeCount">0</span> unsaved changes</div>
                <div>
                    <button class="btn" onclick="discardChanges()">Discard</button>
                    <button class="btn btn-success" onclick="saveAllChanges()">Save All</button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('bid-items')">Project Bid Items</button>
                <button class="tab" onclick="switchTab('installed')">Installed Quantities</button>
                <button class="tab" onclick="switchTab('pay-app')">Pay Application</button>
            </div>
            
            <!-- Bid Items Tab -->
            <div id="bid-items" class="tab-content active">
                <div class="stats">
                    <div class="stat"><h4>Total Items</h4><div class="value" id="totalItems">0</div></div>
                    <div class="stat"><h4>Avg Rate</h4><div class="value" id="avgRate">$0</div></div>
                    <div class="stat"><h4>Avg Material</h4><div class="value" id="avgMaterial">$0</div></div>
                    <div class="stat"><h4>Avg Markup</h4><div class="value" id="avgMarkup">0%</div></div>
                </div>
                
                <div class="toolbar">
                    <input type="text" id="searchInput" placeholder="Search items..." style="max-width: 200px;">
                    <select id="categoryFilter" style="max-width: 150px;">
                        <option value="">All Categories</option>
                    </select>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 80px;">Code</th>
                                <th style="width: 180px;">Name</th>
                                <th style="width: 100px;">Category</th>
                                <th style="width: 60px;">Unit</th>
                                <th style="width: 80px;">Rate</th>
                                <th style="width: 80px;">Material</th>
                                <th style="width: 80px;">Contract</th>
                                <th style="width: 60px;">Markup</th>
                                <th style="width: 60px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bidItemsTable">
                            <tr><td colspan="9">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Installed Quantities Tab -->
            <div id="installed" class="tab-content">
                <div class="stats">
                    <div class="stat"><h4>Entries</h4><div class="value" id="installedEntries">0</div></div>
                    <div class="stat"><h4>Value</h4><div class="value" id="installedValue">$0</div></div>
                    <div class="stat"><h4>Days</h4><div class="value" id="workDays">0</div></div>
                    <div class="stat"><h4>Last Date</h4><div class="value" id="lastDate">-</div></div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th><th>Code</th><th>Name</th><th>Qty</th><th>Unit</th><th>Rate</th><th>Total</th><th>Location</th>
                            </tr>
                        </thead>
                        <tbody id="installedTable">
                            <tr><td colspan="8">No installed quantities</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pay App Tab -->
            <div id="pay-app" class="tab-content">
                <div class="stats">
                    <div class="stat"><h4>Contract</h4><div class="value" id="totalContract">$0</div></div>
                    <div class="stat"><h4>Installed</h4><div class="value" id="totalInstalled">$0</div></div>
                    <div class="stat"><h4>Complete</h4><div class="value" id="percentComplete">0%</div></div>
                    <div class="stat"><h4>Balance</h4><div class="value" id="balance">$0</div></div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th><th>Name</th><th>Rate</th><th>Contract</th><th>Installed</th><th>Progress</th><th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="payAppTable">
                            <tr><td colspan="7">No pay application data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="resultMessage"></div>
    </div>
    
    <script src="auth-helper.js"></script>
    <script>
        let projectBidItems = [];
        let installedQuantities = [];
        let selectedProjectId = null;
        let modifiedItems = {};
        let originalData = {};
        let currentTab = 'bid-items';
        
        const categories = ['CLEARING', 'DEMOLITION', 'EARTHWORK', 'EROSION CONTROL', 'LANDSCAPING', 'MASONRY', 'MISC METALS', 'PAINTING', 'PAVING', 'SITE CONCRETE', 'SPECIALTIES', 'STORM DRAINAGE', 'STRUCTURES', 'TRAFFIC', 'UTILITIES', 'WATERWORKS'];
        const units = ['EA', 'LF', 'SF', 'SY', 'CY', 'TON', 'GAL', 'HR', 'DAY', 'MO', 'LS', 'AC'];
        
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuth = await AuthHelper.init({
                onAuthenticated: (user) => {
                    document.getElementById('userDisplay').textContent = user.name + ' (' + user.role + ')';
                    loadProjects();
                    setupEvents();
                }
            });
            if (!isAuth) return;
        });
        
        function handleLogout() { AuthHelper.logout(); }
        
        async function loadProjects() {
            try {
                const projects = await AuthHelper.apiCall('api/projects');
                const select = document.getElementById('project');
                projects.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.name;
                    select.appendChild(opt);
                });
            } catch (e) {
                showMessage('Error loading projects: ' + e.message, 'error');
            }
        }
        
        async function loadProjectData(projectId) {
            try {
                projectBidItems = await AuthHelper.apiCall('api/project-bid-items?project_id=' + projectId);
                installedQuantities = await AuthHelper.apiCall('api/installed-quantities?project_id=' + projectId);
                
                originalData = {};
                projectBidItems.forEach(item => {
                    originalData[item.project_bid_item_id] = {...item};
                });
                
                populateFilters();
                refreshCurrentTab();
            } catch (e) {
                showMessage('Error loading data: ' + e.message, 'error');
            }
        }
        
        function populateFilters() {
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                select.appendChild(opt);
            });
        }
        
        function renderBidItems() {
            const tbody = document.getElementById('bidItemsTable');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const catFilter = document.getElementById('categoryFilter').value;
            
            let items = projectBidItems;
            if (search) items = items.filter(i => i.item_code.toLowerCase().includes(search) || i.item_name.toLowerCase().includes(search));
            if (catFilter) items = items.filter(i => i.category === catFilter);
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9">No items found</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            items.forEach(item => {
                const rate = Number(item.rate) || 0;
                const material = Number(item.material_cost) || 0;
                const contract = Number(item.contract_quantity) || 0;
                const markup = material > 0 ? ((rate - material) / material * 100).toFixed(1) : 'N/A';
                
                const row = document.createElement('tr');
                row.id = 'row-' + item.project_bid_item_id;
                if (modifiedItems[item.project_bid_item_id]) row.classList.add('modified');
                
                row.innerHTML = `
                    <td>${item.item_code}</td>
                    <td>${item.item_name}</td>
                    <td><select class="editable" data-id="${item.project_bid_item_id}" data-field="category">
                        <option value="">Select</option>
                        ${categories.map(c => `<option value="${c}" ${item.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select></td>
                    <td><select class="editable" data-id="${item.project_bid_item_id}" data-field="unit">
                        <option value="">Select</option>
                        ${units.map(u => `<option value="${u}" ${item.unit === u ? 'selected' : ''}>${u}</option>`).join('')}
                    </select></td>
                    <td><input type="number" class="editable" value="${rate.toFixed(2)}" data-id="${item.project_bid_item_id}" data-field="rate" min="0" step="0.01"></td>
                    <td><input type="number" class="editable" value="${material.toFixed(2)}" data-id="${item.project_bid_item_id}" data-field="material_cost" min="0" step="0.01"></td>
                    <td><input type="number" class="editable" value="${contract.toFixed(2)}" data-id="${item.project_bid_item_id}" data-field="contract_quantity" min="0" step="0.01"></td>
                    <td>${markup}${markup !== 'N/A' ? '%' : ''}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteItem('${item.project_bid_item_id}')">Del</button></td>
                `;
                tbody.appendChild(row);
            });
            
            document.querySelectorAll('.editable').forEach(el => {
                el.addEventListener('change', handleChange);
                el.addEventListener('input', handleInput);
            });
            
            updateBidStats();
        }
        
        function renderInstalled() {
            const tbody = document.getElementById('installedTable');
            if (installedQuantities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No installed quantities</td></tr>';
                updateInstalledStats();
                return;
            }
            
            tbody.innerHTML = '';
            installedQuantities.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.work_date || 'N/A'}</td>
                    <td>${item.item_code || 'N/A'}</td>
                    <td>${item.item_name || 'N/A'}</td>
                    <td>${Number(item.quantity || 0).toFixed(2)}</td>
                    <td>${item.unit || 'EA'}</td>
                    <td>$${Number(item.rate || 0).toFixed(2)}</td>
                    <td>$${Number(item.extension || 0).toFixed(2)}</td>
                    <td>${item.location_description || 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
            
            updateInstalledStats();
        }
        
        function renderPayApp() {
            const tbody = document.getElementById('payAppTable');
            if (projectBidItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No pay application data</td></tr>';
                updatePayAppStats();
                return;
            }
            
            tbody.innerHTML = '';
            projectBidItems.forEach(item => {
                const rate = Number(item.rate) || 0;
                const contractQty = Number(item.contract_quantity) || 0;
                const installedQty = getInstalledQty(item.project_bid_item_id);
                const percent = contractQty > 0 ? (installedQty / contractQty * 100) : 0;
                
                let status = 'pending', statusClass = 'status-pending';
                if (percent >= 100) { status = 'complete'; statusClass = 'status-complete'; }
                else if (percent > 0) { status = 'partial'; statusClass = 'status-partial'; }
                if (installedQty > contractQty && contractQty > 0) { status = 'over'; statusClass = 'over-billed'; }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.item_code}</td>
                    <td>${item.item_name}</td>
                    <td>$${rate.toFixed(2)}</td>
                    <td>${contractQty.toFixed(2)}</td>
                    <td>${installedQty.toFixed(2)}</td>
                    <td><div class="progress"><div class="progress-fill" style="width: ${Math.min(percent, 100)}%"></div><div class="progress-text">${percent.toFixed(1)}%</div></div></td>
                    <td class="${statusClass}">${status}</td>
                `;
                tbody.appendChild(row);
            });
            
            updatePayAppStats();
        }
        
        function getInstalledQty(itemId) {
            return installedQuantities.filter(i => i.project_bid_item_id === itemId).reduce((sum, i) => sum + Number(i.quantity || 0), 0);
        }
        
        function handleChange(e) {
            const itemId = e.target.dataset.id;
            const field = e.target.dataset.field;
            const value = e.target.value;
            trackChange(itemId, field, value);
            
            const row = document.getElementById('row-' + itemId);
            if (modifiedItems[itemId] && Object.keys(modifiedItems[itemId]).length > 0) {
                row.classList.add('modified');
            } else {
                row.classList.remove('modified');
            }
        }
        
        function handleInput(e) {
            const itemId = e.target.dataset.id;
            const field = e.target.dataset.field;
            const value = e.target.value;
            const original = originalData[itemId][field];
            
            let isDiff = false;
            if (['rate', 'material_cost', 'contract_quantity'].includes(field)) {
                isDiff = parseFloat(value) !== parseFloat(original);
            } else {
                isDiff = value !== original;
            }
            
            e.target.classList.toggle('changed', isDiff);
        }
        
        function trackChange(itemId, field, newValue) {
            if (!modifiedItems[itemId]) modifiedItems[itemId] = {};
            
            const original = originalData[itemId][field];
            let compareNew = newValue, compareOrig = original;
            
            if (['rate', 'material_cost', 'contract_quantity'].includes(field)) {
                compareNew = parseFloat(newValue) || 0;
                compareOrig = parseFloat(original) || 0;
            }
            
            if (compareNew !== compareOrig) {
                modifiedItems[itemId][field] = newValue;
            } else {
                delete modifiedItems[itemId][field];
                if (Object.keys(modifiedItems[itemId]).length === 0) delete modifiedItems[itemId];
            }
            
            updateSaveBar();
        }
        
        function updateSaveBar() {
            const count = Object.keys(modifiedItems).length;
            document.getElementById('changeCount').textContent = count;
            document.getElementById('saveBar').classList.toggle('show', count > 0);
        }
        
        async function saveAllChanges() {
            try {
                const updates = [];
                for (const [itemId, changes] of Object.entries(modifiedItems)) {
                    const item = projectBidItems.find(i => i.project_bid_item_id === itemId);
                    if (!item) continue;
                    
                    const data = {
                        rate: changes.rate !== undefined ? parseFloat(changes.rate) : parseFloat(item.rate),
                        material_cost: changes.material_cost !== undefined ? parseFloat(changes.material_cost) : parseFloat(item.material_cost),
                        unit: changes.unit !== undefined ? changes.unit : item.unit,
                        category: changes.category !== undefined ? changes.category : item.category,
                        contract_quantity: changes.contract_quantity !== undefined ? parseFloat(changes.contract_quantity) : parseFloat(item.contract_quantity || 0)
                    };
                    
                    updates.push(AuthHelper.apiCall('api/project-bid-items/' + itemId, { method: 'PUT', body: JSON.stringify(data) }));
                }
                
                if (updates.length > 0) {
                    await Promise.all(updates);
                    showMessage(`Updated ${updates.length} item(s)`, 'success');
                    modifiedItems = {};
                    updateSaveBar();
                    await loadProjectData(selectedProjectId);
                }
            } catch (e) {
                showMessage('Error saving: ' + e.message, 'error');
            }
        }
        
        function discardChanges() {
            if (confirm('Discard all unsaved changes?')) {
                modifiedItems = {};
                updateSaveBar();
                refreshCurrentTab();
            }
        }
        
        function switchTab(tab) {
            if (Object.keys(modifiedItems).length > 0 && !confirm('You have unsaved changes. Continue?')) return;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
            currentTab = tab;
            refreshCurrentTab();
        }
        
        function refreshCurrentTab() {
            if (currentTab === 'bid-items') renderBidItems();
            else if (currentTab === 'installed') renderInstalled();
            else if (currentTab === 'pay-app') renderPayApp();
        }
        
        function updateBidStats() {
            const items = projectBidItems.length;
            const totalRate = projectBidItems.reduce((s, i) => s + Number(i.rate || 0), 0);
            const totalMaterial = projectBidItems.reduce((s, i) => s + Number(i.material_cost || 0), 0);
            let markupSum = 0, markupCount = 0;
            
            projectBidItems.forEach(i => {
                const rate = Number(i.rate || 0);
                const material = Number(i.material_cost || 0);
                if (material > 0) { markupSum += ((rate - material) / material * 100); markupCount++; }
            });
            
            document.getElementById('totalItems').textContent = items;
            document.getElementById('avgRate').textContent = items > 0 ? '$' + (totalRate / items).toFixed(2) : '$0';
            document.getElementById('avgMaterial').textContent = items > 0 ? '$' + (totalMaterial / items).toFixed(2) : '$0';
            document.getElementById('avgMarkup').textContent = markupCount > 0 ? (markupSum / markupCount).toFixed(1) + '%' : '0%';
        }
        
        function updateInstalledStats() {
            const entries = installedQuantities.length;
            const value = installedQuantities.reduce((s, i) => s + Number(i.extension || 0), 0);
            const dates = [...new Set(installedQuantities.map(i => i.work_date).filter(d => d))];
            const lastDate = dates.sort().pop() || '-';
            
            document.getElementById('installedEntries').textContent = entries;
            document.getElementById('installedValue').textContent = '$' + value.toFixed(2);
            document.getElementById('workDays').textContent = dates.length;
            document.getElementById('lastDate').textContent = lastDate;
        }
        
        function updatePayAppStats() {
            const totalContract = projectBidItems.reduce((s, i) => s + ((Number(i.contract_quantity || 0)) * Number(i.rate || 0)), 0);
            const totalInstalled = projectBidItems.reduce((s, i) => s + (getInstalledQty(i.project_bid_item_id) * Number(i.rate || 0)), 0);
            const percent = totalContract > 0 ? (totalInstalled / totalContract * 100) : 0;
            const balance = totalContract - totalInstalled;
            
            document.getElementById('totalContract').textContent = '$' + totalContract.toFixed(2);
            document.getElementById('totalInstalled').textContent = '$' + totalInstalled.toFixed(2);
            document.getElementById('percentComplete').textContent = percent.toFixed(1) + '%';
            document.getElementById('balance').textContent = '$' + balance.toFixed(2);
        }
        
        function setupEvents() {
            document.getElementById('project').addEventListener('change', function() {
                selectedProjectId = this.value;
                if (selectedProjectId) {
                    loadProjectData(selectedProjectId);
                    document.getElementById('mainContent').classList.remove('hidden');
                } else {
                    document.getElementById('mainContent').classList.add('hidden');
                }
            });
            
            document.getElementById('searchInput').addEventListener('input', renderBidItems);
            document.getElementById('categoryFilter').addEventListener('change', renderBidItems);
            
            window.addEventListener('beforeunload', function(e) {
                if (Object.keys(modifiedItems).length > 0) { e.preventDefault(); e.returnValue = ''; }
            });
        }
        
        function deleteItem(id) {
            if (confirm('Delete this item?')) showMessage('Delete not implemented', 'error');
        }
        
        function showMessage(msg, type) {
            const div = document.getElementById('resultMessage');
            div.className = 'alert alert-' + type;
            div.textContent = msg;
            if (type === 'success') setTimeout(() => { div.innerHTML = ''; div.className = ''; }, 3000);
        }
    </script>
</body>
</html>

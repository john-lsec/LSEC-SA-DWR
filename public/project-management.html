<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSEC SA Project Management</title>
    <!-- No external scripts needed - using native browser capabilities -->
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #1a1a1a; color: #e0e0e0; }
        .container { max-width: 1200px; margin: 0 auto; background: #121212; padding: 20px; border-radius: 12px; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #4a9eff; }
        .header h1 { color: #4a9eff; margin: 0; font-size: 2rem; }
        .user-info { position: absolute; top: 20px; right: 20px; font-size: 0.9rem; }
        .logout-btn { background: #dc2626; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
        
        .section { background: #1e1e1e; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        
        /* Save Bar */
        .save-bar { background: #1e3d29; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0; 
                   display: none; align-items: center; justify-content: space-between; border: 1px solid #16a34a; }
        .save-bar.show { display: flex; }
        .save-bar-text { color: #4ade80; font-weight: 600; }
        
        /* Tabs */
        .tabs { display: flex; background: #2a2a2a; border-radius: 8px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 12px 20px; background: transparent; border: none; color: #888; cursor: pointer; 
               font-weight: 600; border-right: 1px solid #333; }
        .tab:last-child { border-right: none; }
        .tab.active { background: #4a9eff; color: white; }
        .tab:hover:not(.active) { background: #333; color: #e0e0e0; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Form Elements */
        input, select { width: 100%; padding: 10px; border: 2px solid #404040; border-radius: 6px; 
                       background: #2a2a2a; color: #e0e0e0; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: #4a9eff; background: #333; }
        
        /* Editable Fields */
        .editable { background: transparent; border: 1px solid transparent; padding: 4px 8px; border-radius: 4px; 
                   transition: all 0.2s ease; font-size: 13px; }
        .editable:hover { background: #2a2a2a; border-color: #404040; }
        .editable:focus { background: #333; border-color: #4a9eff; }
        .editable.modified { background: #3d1e1e; border-color: #dc2626; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; 
               transition: all 0.3s ease; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover { background: #15803d; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-secondary { background: #404040; color: #e0e0e0; }
        .btn-secondary:hover { background: #525252; }
        .btn-primary { background: #4a9eff; color: white; }
        .btn-primary:hover { background: #2b7edb; }
        
        /* Toolbar */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; flex-wrap: wrap; gap: 10px; }
        .toolbar-left { display: flex; gap: 10px; align-items: center; flex: 1; }
        .search-box { flex: 1; max-width: 300px; }
        .export-buttons { display: flex; gap: 10px; }
        
        /* Stats Grid */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat { background: #2a2a2a; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #404040; }
        .stat h4 { margin: 0 0 10px 0; color: #888; font-size: 12px; text-transform: uppercase; }
        .stat .value { font-size: 24px; font-weight: bold; color: #4a9eff; }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #2a2a2a; padding: 12px; text-align: left; font-weight: 600; color: #4a9eff; 
             border-bottom: 2px solid #404040; position: sticky; top: 0; z-index: 10; }
        td { padding: 10px; border-bottom: 1px solid #333; }
        tr:hover { background: #1e1e1e; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; 
                overflow: auto; background: rgba(0, 0, 0, 0.7); }
        .modal-content { background: #1e1e1e; margin: 5% auto; padding: 20px; border: 1px solid #404040; 
                        width: 90%; max-width: 600px; border-radius: 12px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; 
                       padding-bottom: 15px; border-bottom: 2px solid #404040; }
        .modal-title { color: #4a9eff; font-size: 1.5rem; margin: 0; }
        .close { color: #888; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s; }
        .close:hover, .close:focus { color: #f87171; }
        
        /* Form Grid */
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group.full-width { grid-column: span 2; }
        .form-group label { display: block; margin-bottom: 5px; color: #4a9eff; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; }
        textarea { resize: vertical; min-height: 80px; }
        
        /* Modal Buttons */
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; 
                       padding-top: 20px; border-top: 1px solid #404040; }
        
        /* Message */
        .message { padding: 15px; margin: 20px 0; border-radius: 8px; text-align: center; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .message.success { background: #16a34a; color: white; }
        .message.error { background: #dc2626; color: white; }
        .message.info { background: #4a9eff; color: white; }
        
        /* Hidden */
        .hidden { display: none !important; }
        
        /* Progress Bar */
        .progress { background: #333; height: 20px; border-radius: 4px; position: relative; overflow: hidden; }
        .progress-fill { background: #28a745; height: 100%; transition: width 0.3s; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                        color: white; font-size: 10px; font-weight: bold; }
        
        /* Status colors */
        .status-complete { color: #4ade80; }
        .status-partial { color: #fbbf24; }
        .status-pending { color: #f87171; }
        .over-billed { color: #f87171; font-weight: bold; }
        
        /* Autocomplete Styles */
        .autocomplete-container { position: relative; }
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
            margin-top: 2px;
        }
        .autocomplete-results.show { display: block; }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            transition: background 0.2s;
        }
        .autocomplete-item:hover, .autocomplete-item.selected {
            background: #333;
        }
        .autocomplete-item-code {
            color: #4a9eff;
            font-weight: bold;
        }
        .autocomplete-item-name {
            color: #e0e0e0;
            margin-left: 10px;
        }
        .autocomplete-item-category {
            color: #888;
            font-size: 0.85rem;
            margin-top: 3px;
        }
        .autocomplete-no-results {
            padding: 15px;
            text-align: center;
            color: #888;
        }
        #bidItemSearch.has-selection {
            background: #1e3d29;
            border-color: #16a34a;
        }
        
        @media (max-width: 768px) {
            .stats { grid-template-columns: repeat(2, 1fr); }
            .toolbar { flex-direction: column; align-items: stretch; }
            .toolbar-left { flex-direction: column; }
            .export-buttons { justify-content: center; }
            .form-grid { grid-template-columns: 1fr; }
            .form-group.full-width { grid-column: span 1; }
        }
    </style>
    <script src="auth-helper.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Project Management</h1>
            <div class="user-info">
                <span id="userDisplay">Loading...</span>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </div>
        
        <div class="section">
            <label>Project:</label>
            <select id="project">
                <option value="">-- Select Project --</option>
            </select>
        </div>
        
        <div id="mainContent" class="section hidden">
            <!-- Save Bar -->
            <div id="saveBar" class="save-bar">
                <div class="save-bar-text"><span id="changeCount">0</span> unsaved changes</div>
                <div>
                    <button class="btn" onclick="discardChanges()">Discard</button>
                    <button class="btn btn-success" onclick="saveAllChanges()">Save All</button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('bid-items')">Project Bid Items</button>
                <button class="tab" onclick="switchTab('installed')">Installed Quantities</button>
                <button class="tab" onclick="switchTab('pay-app')">Pay Application</button>
            </div>
            
            <!-- Bid Items Tab -->
            <div id="bid-items" class="tab-content active">
                <div class="stats">
                    <div class="stat"><h4>Total Items</h4><div class="value" id="totalItems">0</div></div>
                    <div class="stat"><h4>Avg Rate</h4><div class="value" id="avgRate">$0</div></div>
                    <div class="stat"><h4>Avg Material</h4><div class="value" id="avgMaterial">$0</div></div>
                    <div class="stat"><h4>Avg Markup</h4><div class="value" id="avgMarkup">0%</div></div>
                </div>
                
                <div class="toolbar">
                    <div class="toolbar-left">
                        <input type="text" id="searchInput" class="search-box" placeholder="Search items...">
                        <select id="categoryFilter">
                            <option value="">All Categories</option>
                        </select>
                        <button class="btn btn-primary" onclick="openAddBidItemModal()">
                            Add Bid Item
                        </button>
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="exportToCSV('bid-items')">Export CSV</button>
                        <button class="btn btn-secondary" onclick="exportToPDF('bid-items')">Export PDF</button>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Item Name</th>
                            <th>Category</th>
                            <th>Unit</th>
                            <th>Rate</th>
                            <th>Material Cost</th>
                            <th>Markup %</th>
                            <th>Contract Qty</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bidItemsTable">
                        <tr><td colspan="9">Select a project to view items</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Installed Quantities Tab -->
            <div id="installed" class="tab-content">
                <div class="stats">
                    <div class="stat"><h4>Total Entries</h4><div class="value" id="installedEntries">0</div></div>
                    <div class="stat"><h4>Total Value</h4><div class="value" id="installedValue">$0</div></div>
                    <div class="stat"><h4>Work Days</h4><div class="value" id="workDays">0</div></div>
                    <div class="stat"><h4>Last Entry</h4><div class="value" id="lastDate">-</div></div>
                </div>
                
                <div class="toolbar">
                    <div class="toolbar-left">
                        <input type="date" id="dateFilter" onchange="renderInstalled()">
                        <select id="itemFilter" onchange="renderInstalled()">
                            <option value="">All Items</option>
                        </select>
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="exportToCSV('installed')">Export CSV</button>
                        <button class="btn btn-secondary" onclick="exportToPDF('installed')">Export PDF</button>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Item Code</th>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                            <th>Rate</th>
                            <th>Extension</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="installedTable">
                        <tr><td colspan="9">No installed quantities recorded</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pay Application Tab -->
            <div id="pay-app" class="tab-content">
                <div class="stats">
                    <div class="stat"><h4>Contract Total</h4><div class="value" id="totalContract">$0</div></div>
                    <div class="stat"><h4>Installed Total</h4><div class="value" id="totalInstalled">$0</div></div>
                    <div class="stat"><h4>% Complete</h4><div class="value" id="percentComplete">0%</div></div>
                    <div class="stat"><h4>Balance</h4><div class="value" id="balance">$0</div></div>
                </div>
                
                <div class="toolbar">
                    <div class="toolbar-left">
                        <select id="payAppFilter" onchange="renderPayApp()">
                            <option value="all">All Items</option>
                            <option value="active">Active Only</option>
                            <option value="complete">Complete</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="exportToCSV('pay-app')">Export CSV</button>
                        <button class="btn btn-secondary" onclick="exportToPDF('pay-app')">Export PDF</button>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>Item Name</th>
                            <th>Contract Qty</th>
                            <th>Installed Qty</th>
                            <th>Unit</th>
                            <th>Rate</th>
                            <th>Contract Amt</th>
                            <th>Installed Amt</th>
                            <th>% Complete</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="payAppTable">
                        <tr><td colspan="10">No data available</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Message Container -->
        <div id="messageContainer"></div>
    </div>
    
    <!-- Add Bid Item Modal -->
    <div id="addBidItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Bid Item to Project</h2>
                <span class="close" onclick="closeAddBidItemModal()">&times;</span>
            </div>
            
            <form id="addBidItemForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="bidItemSearch">Search Bid Item *</label>
                        <div class="autocomplete-container">
                            <input type="text" id="bidItemSearch" placeholder="Type to search item code or name..." required autocomplete="off">
                            <input type="hidden" id="bidItemId" required>
                            <div id="autocompleteResults" class="autocomplete-results"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="bidItemCategory">Category</label>
                        <select id="bidItemCategory">
                            <option value="">-- Select Category --</option>
                            <option value="CLEARING">CLEARING</option>
                            <option value="DEMOLITION">DEMOLITION</option>
                            <option value="EARTHWORK">EARTHWORK</option>
                            <option value="EROSION CONTROL">EROSION CONTROL</option>
                            <option value="LANDSCAPING">LANDSCAPING</option>
                            <option value="MASONRY">MASONRY</option>
                            <option value="MISC METALS">MISC METALS</option>
                            <option value="PAINTING">PAINTING</option>
                            <option value="PAVING">PAVING</option>
                            <option value="SITE CONCRETE">SITE CONCRETE</option>
                            <option value="SPECIALTIES">SPECIALTIES</option>
                            <option value="STORM DRAINAGE">STORM DRAINAGE</option>
                            <option value="STRUCTURES">STRUCTURES</option>
                            <option value="TRAFFIC">TRAFFIC</option>
                            <option value="UTILITIES">UTILITIES</option>
                            <option value="WATERWORKS">WATERWORKS</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="bidItemUnit">Unit *</label>
                        <input type="text" id="bidItemUnit" required placeholder="e.g., CY, SF, LF">
                    </div>
                    
                    <div class="form-group">
                        <label for="bidItemRate">Rate ($) *</label>
                        <input type="number" id="bidItemRate" required min="0" step="0.01" placeholder="0.00">
                    </div>
                    
                    <div class="form-group">
                        <label for="bidItemMaterialCost">Material Cost ($)</label>
                        <input type="number" id="bidItemMaterialCost" min="0" step="0.01" placeholder="0.00">
                    </div>
                    
                    <div class="form-group">
                        <label for="bidItemContractQty">Contract Quantity</label>
                        <input type="number" id="bidItemContractQty" min="0" step="0.01" placeholder="0.00">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="bidItemNotes">Notes</label>
                        <textarea id="bidItemNotes" rows="3" placeholder="Optional notes..."></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddBidItemModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Bid Item</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Global variables
        let selectedProjectId = null;
        let selectedProjectName = '';
        let projectBidItems = [];
        let installedQuantities = [];
        let modifiedItems = {};
        let originalData = {};
        let currentTab = 'bid-items';
        let availableBidItems = [];
        let selectedBidItem = null;
        let autocompleteIndex = -1;
        
        const categories = ['CLEARING', 'DEMOLITION', 'EARTHWORK', 'EROSION CONTROL', 'LANDSCAPING', 
                          'MASONRY', 'MISC METALS', 'PAINTING', 'PAVING', 'SITE CONCRETE', 
                          'SPECIALTIES', 'STORM DRAINAGE', 'STRUCTURES', 'TRAFFIC', 'UTILITIES', 'WATERWORKS'];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuth = await AuthHelper.init({
                onAuthenticated: function(user) {
                    document.getElementById('userDisplay').textContent = user.name + ' (' + user.role + ')';
                    loadProjects();
                    setupEvents();
                    setupAutocomplete(); // Initialize autocomplete
                }
            });
            if (!isAuth) return;
        });
        
        function handleLogout() {
            AuthHelper.logout();
        }
        
        // Add Bid Item Modal Functions
        async function openAddBidItemModal() {
            if (!selectedProjectId) {
                showMessage('Please select a project first', 'error');
                return;
            }
            
            // Show modal immediately with loading state
            document.getElementById('addBidItemModal').style.display = 'block';
            const searchInput = document.getElementById('bidItemSearch');
            searchInput.disabled = true;
            searchInput.placeholder = 'Loading bid items...';
            
            // Load ALL available bid items (all pages)
            try {
                availableBidItems = [];
                let currentPage = 1;
                let hasMorePages = true;
                let totalLoaded = 0;
                
                // Fetch all pages of bid items
                while (hasMorePages) {
                    const response = await AuthHelper.apiCall(`api/bid-items?page=${currentPage}&limit=500`);
                    
                    let items = [];
                    let pagination = null;
                    
                    // Handle paginated response format
                    if (response && response.items && Array.isArray(response.items)) {
                        items = response.items;
                        pagination = response.pagination;
                    } else if (Array.isArray(response)) {
                        items = response;
                        hasMorePages = false; // Non-paginated response, stop after this
                    } else {
                        console.error('Unexpected response format:', response);
                        showMessage('Unexpected response format from bid items API', 'error');
                        searchInput.disabled = false;
                        searchInput.placeholder = 'Type to search item code or name...';
                        closeAddBidItemModal();
                        return;
                    }
                    
                    // Add items to our collection
                    availableBidItems = availableBidItems.concat(items);
                    totalLoaded = availableBidItems.length;
                    
                    // Update loading placeholder with count
                    searchInput.placeholder = `Loading bid items... (${totalLoaded} loaded)`;
                    
                    // Check if there are more pages
                    if (pagination) {
                        hasMorePages = pagination.hasNext;
                        currentPage++;
                    } else {
                        hasMorePages = false;
                    }
                    
                    // Safety check to prevent infinite loop
                    if (currentPage > 50) {
                        console.warn('Too many pages, stopping at page 50');
                        hasMorePages = false;
                    }
                }
                
                // Filter for active items only
                availableBidItems = availableBidItems.filter(item => item.is_active !== false);
                
                console.log(`Loaded ${availableBidItems.length} active bid items`);
                
                if (availableBidItems.length === 0) {
                    showMessage('No bid items available. Please add bid items first.', 'error');
                    closeAddBidItemModal();
                    return;
                }
                
                // Reset form and clear selection
                document.getElementById('addBidItemForm').reset();
                searchInput.value = '';
                searchInput.disabled = false;
                searchInput.placeholder = `Search ${availableBidItems.length} bid items (type code or name)...`;
                document.getElementById('bidItemId').value = '';
                searchInput.classList.remove('has-selection');
                selectedBidItem = null;
                autocompleteIndex = -1;
                
                // Clear autocomplete results
                const resultsDiv = document.getElementById('autocompleteResults');
                resultsDiv.innerHTML = '';
                resultsDiv.classList.remove('show');
                
                // Focus on search input
                searchInput.focus();
                
            } catch (error) {
                console.error('Error loading bid items:', error);
                showMessage('Error loading bid items. Please check console for details.', 'error');
                closeAddBidItemModal();
            }
        }
        
        function closeAddBidItemModal() {
            document.getElementById('addBidItemModal').style.display = 'none';
            document.getElementById('addBidItemForm').reset();
            document.getElementById('bidItemSearch').classList.remove('has-selection');
            selectedBidItem = null;
            autocompleteIndex = -1;
            
            // Clear autocomplete results
            const resultsDiv = document.getElementById('autocompleteResults');
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('show');
        }
        
        // Autocomplete functions
        function setupAutocomplete() {
            const searchInput = document.getElementById('bidItemSearch');
            const resultsDiv = document.getElementById('autocompleteResults');
            
            // Search input handler
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase().trim();
                
                // Clear selection if user is typing
                if (selectedBidItem) {
                    selectedBidItem = null;
                    document.getElementById('bidItemId').value = '';
                    searchInput.classList.remove('has-selection');
                    clearBidItemFields();
                }
                
                if (query.length < 2) {
                    resultsDiv.innerHTML = '';
                    resultsDiv.classList.remove('show');
                    autocompleteIndex = -1;
                    return;
                }
                
                // Filter bid items
                const filtered = availableBidItems.filter(item => {
                    return (item.item_code && item.item_code.toLowerCase().includes(query)) ||
                           (item.item_name && item.item_name.toLowerCase().includes(query));
                });
                
                displayAutocompleteResults(filtered);
            });
            
            // Keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                const resultsDiv = document.getElementById('autocompleteResults');
                const items = resultsDiv.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    autocompleteIndex = Math.min(autocompleteIndex + 1, items.length - 1);
                    updateAutocompleteSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    autocompleteIndex = Math.max(autocompleteIndex - 1, -1);
                    updateAutocompleteSelection(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (autocompleteIndex >= 0 && items[autocompleteIndex]) {
                        const itemId = items[autocompleteIndex].dataset.itemId;
                        selectBidItem(itemId);
                    }
                } else if (e.key === 'Escape') {
                    resultsDiv.innerHTML = '';
                    resultsDiv.classList.remove('show');
                    autocompleteIndex = -1;
                }
            });
            
            // Click outside to close
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    resultsDiv.innerHTML = '';
                    resultsDiv.classList.remove('show');
                    autocompleteIndex = -1;
                }
            });
        }
        
        function displayAutocompleteResults(items) {
            const resultsDiv = document.getElementById('autocompleteResults');
            
            if (items.length === 0) {
                resultsDiv.innerHTML = '<div class="autocomplete-no-results">No matching items found</div>';
                resultsDiv.classList.add('show');
                autocompleteIndex = -1;
                return;
            }
            
            resultsDiv.innerHTML = '';
            
            // Show up to 20 results for better coverage
            const maxResults = Math.min(items.length, 20);
            
            for (let i = 0; i < maxResults; i++) {
                const item = items[i];
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.dataset.itemId = item.id;
                
                div.innerHTML = `
                    <div>
                        <span class="autocomplete-item-code">${item.item_code || ''}</span>
                        <span class="autocomplete-item-name">${item.item_name || ''}</span>
                    </div>
                    ${item.category ? `<div class="autocomplete-item-category">${item.category}</div>` : ''}
                `;
                
                div.addEventListener('click', function() {
                    selectBidItem(item.id);
                });
                
                resultsDiv.appendChild(div);
            }
            
            // Add a note if there are more results
            if (items.length > maxResults) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'autocomplete-no-results';
                moreDiv.style.fontSize = '0.85rem';
                moreDiv.textContent = `...and ${items.length - maxResults} more results. Keep typing to refine.`;
                resultsDiv.appendChild(moreDiv);
            }
            
            resultsDiv.classList.add('show');
            autocompleteIndex = -1;
        }
        
        function updateAutocompleteSelection(items) {
            items.forEach((item, index) => {
                if (index === autocompleteIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        function selectBidItem(itemId) {
            selectedBidItem = availableBidItems.find(item => item.id === itemId);
            
            if (!selectedBidItem) return;
            
            // Update search input
            const searchInput = document.getElementById('bidItemSearch');
            searchInput.value = `${selectedBidItem.item_code} - ${selectedBidItem.item_name}`;
            searchInput.classList.add('has-selection');
            
            // Set hidden ID field
            document.getElementById('bidItemId').value = selectedBidItem.id;
            
            // Update form fields
            const categorySelect = document.getElementById('bidItemCategory');
            if (selectedBidItem.category) {
                categorySelect.value = selectedBidItem.category;
            } else {
                categorySelect.value = '';
            }
            
            document.getElementById('bidItemUnit').value = selectedBidItem.default_unit || '';
            document.getElementById('bidItemMaterialCost').value = selectedBidItem.material_cost || '0';
            
            // Clear autocomplete results
            const resultsDiv = document.getElementById('autocompleteResults');
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('show');
            autocompleteIndex = -1;
            
            // Focus on rate field
            document.getElementById('bidItemRate').focus();
        }
        
        function clearBidItemFields() {
            document.getElementById('bidItemCategory').value = '';
            document.getElementById('bidItemUnit').value = '';
            document.getElementById('bidItemMaterialCost').value = '';
        }
        
        // Handle form submission
        document.getElementById('addBidItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const bidItemId = document.getElementById('bidItemId').value;
            if (!bidItemId) {
                showMessage('Please select a bid item from the search results', 'error');
                document.getElementById('bidItemSearch').focus();
                return;
            }
            
            // Check if item already exists in project
            if (projectBidItems.some(item => item.bid_item_id === bidItemId)) {
                showMessage('This bid item already exists in the project', 'error');
                return;
            }
            
            const data = {
                project_id: selectedProjectId,
                bid_item_id: bidItemId,
                unit: document.getElementById('bidItemUnit').value,
                rate: parseFloat(document.getElementById('bidItemRate').value) || 0,
                material_cost: parseFloat(document.getElementById('bidItemMaterialCost').value) || 0,
                contract_quantity: parseFloat(document.getElementById('bidItemContractQty').value) || 0,
                notes: document.getElementById('bidItemNotes').value,
                category: document.getElementById('bidItemCategory').value || null
            };
            
            try {
                await AuthHelper.apiCall('api/project-bid-items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                showMessage('Bid item added successfully', 'success');
                closeAddBidItemModal();
                
                // Reload project data
                await loadProjectData(selectedProjectId);
                updateBidStats();
            } catch (error) {
                console.error('Error adding bid item:', error);
                showMessage('Error adding bid item. Please check console for details.', 'error');
            }
        });
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('addBidItemModal');
            const resultsDiv = document.getElementById('autocompleteResults');
            
            // Close modal if clicking outside of it
            if (event.target === modal) {
                closeAddBidItemModal();
            }
            
            // Close autocomplete if clicking outside of it
            if (!event.target.closest('.autocomplete-container')) {
                resultsDiv.innerHTML = '';
                resultsDiv.classList.remove('show');
                autocompleteIndex = -1;
            }
        };
        
        async function loadProjects() {
            try {
                const projects = await AuthHelper.apiCall('api/projects');
                const select = document.getElementById('project');
                
                // Ensure we have an array
                const projectList = Array.isArray(projects) ? projects : [];
                
                if (projectList.length === 0) {
                    select.innerHTML = '<option value="">-- No Projects Available --</option>';
                    return;
                }
                
                select.innerHTML = '<option value="">-- Select Project --</option>';
                projectList.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.name;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Error loading projects:', e);
                showMessage('Error loading projects. Please check console for details.', 'error');
            }
        }
        
        async function loadProjectData(projectId) {
            try {
                // Use the correct endpoint paths with 'api/' prefix
                projectBidItems = await AuthHelper.apiCall(`api/project-bid-items?project_id=${projectId}`);
                installedQuantities = await AuthHelper.apiCall(`api/installed-quantities?project_id=${projectId}`);
                
                // Ensure we have arrays
                projectBidItems = Array.isArray(projectBidItems) ? projectBidItems : [];
                installedQuantities = Array.isArray(installedQuantities) ? installedQuantities : [];
                
                originalData = {};
                projectBidItems.forEach(item => {
                    originalData[item.project_bid_item_id] = {...item};
                });
                
                populateFilters();
                refreshCurrentTab();
            } catch (e) {
                console.error('Error loading project data:', e);
                showMessage('Error loading data. Please check console for details.', 'error');
                // Initialize with empty arrays if error
                projectBidItems = [];
                installedQuantities = [];
                refreshCurrentTab();
            }
        }
        
        function populateFilters() {
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                select.appendChild(opt);
            });
        }
        
        function renderBidItems() {
            const tbody = document.getElementById('bidItemsTable');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const catFilter = document.getElementById('categoryFilter').value;
            
            let items = projectBidItems;
            if (search) items = items.filter(i => i.item_code.toLowerCase().includes(search) || i.item_name.toLowerCase().includes(search));
            if (catFilter) items = items.filter(i => i.category === catFilter);
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9">No items found</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            items.forEach(item => {
                const rate = Number(item.rate) || 0;
                const material = Number(item.material_cost) || 0;
                const contract = Number(item.contract_quantity) || 0;
                const markup = material > 0 ? ((rate - material) / material * 100).toFixed(1) : '0.0';
                const isModified = modifiedItems[item.project_bid_item_id];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.item_code}</td>
                    <td>${item.item_name}</td>
                    <td>${item.category}</td>
                    <td><input class="editable ${isModified ? 'modified' : ''}" value="${item.unit}" 
                               onchange="updateField('${item.project_bid_item_id}', 'unit', this.value)"></td>
                    <td><input type="number" class="editable ${isModified ? 'modified' : ''}" value="${rate.toFixed(2)}" 
                               onchange="updateField('${item.project_bid_item_id}', 'rate', this.value)"></td>
                    <td><input type="number" class="editable ${isModified ? 'modified' : ''}" value="${material.toFixed(2)}" 
                               onchange="updateField('${item.project_bid_item_id}', 'material_cost', this.value)"></td>
                    <td>${markup}%</td>
                    <td><input type="number" class="editable ${isModified ? 'modified' : ''}" value="${contract.toFixed(2)}" 
                               onchange="updateField('${item.project_bid_item_id}', 'contract_quantity', this.value)"></td>
                    <td><button class="btn btn-danger" onclick="deleteItem('${item.project_bid_item_id}')">Delete</button></td>
                `;
                tbody.appendChild(row);
            });
            
            updateBidStats();
        }
        
        function renderInstalled() {
            const tbody = document.getElementById('installedTable');
            const dateFilter = document.getElementById('dateFilter').value;
            const itemFilter = document.getElementById('itemFilter').value;
            
            let items = installedQuantities;
            if (dateFilter) items = items.filter(i => i.work_date === dateFilter);
            if (itemFilter) items = items.filter(i => i.project_bid_item_id === itemFilter);
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9">No installed quantities recorded</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            items.forEach(item => {
                const bidItem = projectBidItems.find(bi => bi.project_bid_item_id === item.project_bid_item_id);
                if (!bidItem) return;
                
                const qty = Number(item.quantity) || 0;
                const rate = Number(bidItem.rate) || 0;
                const ext = qty * rate;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.work_date}</td>
                    <td>${bidItem.item_code}</td>
                    <td>${bidItem.item_name}</td>
                    <td>${qty.toFixed(2)}</td>
                    <td>${bidItem.unit}</td>
                    <td>$${rate.toFixed(2)}</td>
                    <td>$${ext.toFixed(2)}</td>
                    <td>${item.notes || '-'}</td>
                    <td><button class="btn btn-danger" onclick="deleteInstalledQty('${item.id}')">Delete</button></td>
                `;
                tbody.appendChild(row);
            });
            
            updateInstalledStats();
        }
        
        function renderPayApp() {
            const tbody = document.getElementById('payAppTable');
            const filter = document.getElementById('payAppFilter').value;
            
            let items = projectBidItems;
            if (filter === 'active') items = items.filter(i => getInstalledQty(i.project_bid_item_id) > 0);
            else if (filter === 'complete') items = items.filter(i => {
                const installed = getInstalledQty(i.project_bid_item_id);
                const contract = Number(i.contract_quantity) || 0;
                return contract > 0 && installed >= contract;
            });
            else if (filter === 'pending') items = items.filter(i => {
                const installed = getInstalledQty(i.project_bid_item_id);
                const contract = Number(i.contract_quantity) || 0;
                return contract > 0 && installed < contract;
            });
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10">No items found</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            items.forEach(item => {
                const contract = Number(item.contract_quantity) || 0;
                const rate = Number(item.rate) || 0;
                const installed = getInstalledQty(item.project_bid_item_id);
                const contractAmt = contract * rate;
                const installedAmt = installed * rate;
                const percent = contract > 0 ? (installed / contract * 100) : 0;
                const balance = contractAmt - installedAmt;
                
                let statusClass = 'status-pending';
                if (percent >= 100) statusClass = 'status-complete';
                else if (percent > 0) statusClass = 'status-partial';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.item_code}</td>
                    <td>${item.item_name}</td>
                    <td>${contract.toFixed(2)}</td>
                    <td>${installed.toFixed(2)}</td>
                    <td>${item.unit}</td>
                    <td>$${rate.toFixed(2)}</td>
                    <td>$${contractAmt.toFixed(2)}</td>
                    <td>$${installedAmt.toFixed(2)}</td>
                    <td class="${percent > 100 ? 'over-billed' : statusClass}">${percent.toFixed(1)}%</td>
                    <td>$${balance.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
            
            updatePayAppStats();
        }
        
        function getInstalledQty(projectBidItemId) {
            return installedQuantities
                .filter(i => i.project_bid_item_id === projectBidItemId)
                .reduce((sum, i) => sum + (Number(i.quantity) || 0), 0);
        }
        
        function updateField(id, field, value) {
            const item = projectBidItems.find(i => i.project_bid_item_id === id);
            if (!item) return;
            
            const numFields = ['rate', 'material_cost', 'contract_quantity'];
            if (numFields.includes(field)) {
                value = parseFloat(value) || 0;
            }
            
            item[field] = value;
            
            if (!modifiedItems[id]) modifiedItems[id] = {};
            modifiedItems[id][field] = value;
            
            updateSaveBar();
            if (field === 'rate' || field === 'material_cost') {
                renderBidItems();
            }
        }
        
        function updateSaveBar() {
            const count = Object.keys(modifiedItems).length;
            const bar = document.getElementById('saveBar');
            const countEl = document.getElementById('changeCount');
            
            if (count > 0) {
                bar.classList.add('show');
                countEl.textContent = count;
            } else {
                bar.classList.remove('show');
            }
        }
        
        async function saveAllChanges() {
            try {
                for (const id in modifiedItems) {
                    await AuthHelper.apiCall(`api/project-bid-items/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(modifiedItems[id])
                    });
                }
                
                showMessage('All changes saved successfully', 'success');
                modifiedItems = {};
                updateSaveBar();
                await loadProjectData(selectedProjectId);
            } catch (e) {
                console.error('Error saving changes:', e);
                showMessage('Error saving changes. Please check console for details.', 'error');
            }
        }
        
        function discardChanges() {
            if (confirm('Discard all unsaved changes?')) {
                projectBidItems.forEach(item => {
                    if (originalData[item.project_bid_item_id]) {
                        Object.assign(item, originalData[item.project_bid_item_id]);
                    }
                });
                modifiedItems = {};
                updateSaveBar();
                refreshCurrentTab();
            }
        }
        
        function switchTab(tab) {
            if (Object.keys(modifiedItems).length > 0 && !confirm('You have unsaved changes. Continue?')) return;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
            currentTab = tab;
            refreshCurrentTab();
        }
        
        function refreshCurrentTab() {
            if (currentTab === 'bid-items') renderBidItems();
            else if (currentTab === 'installed') renderInstalled();
            else if (currentTab === 'pay-app') renderPayApp();
        }
        
        function updateBidStats() {
            const items = projectBidItems.length;
            const totalRate = projectBidItems.reduce((s, i) => s + Number(i.rate || 0), 0);
            const totalMaterial = projectBidItems.reduce((s, i) => s + Number(i.material_cost || 0), 0);
            let markupSum = 0, markupCount = 0;
            
            projectBidItems.forEach(i => {
                const rate = Number(i.rate || 0);
                const material = Number(i.material_cost || 0);
                if (material > 0) { markupSum += ((rate - material) / material * 100); markupCount++; }
            });
            
            document.getElementById('totalItems').textContent = items;
            document.getElementById('avgRate').textContent = items > 0 ? '$' + (totalRate / items).toFixed(2) : '$0';
            document.getElementById('avgMaterial').textContent = items > 0 ? '$' + (totalMaterial / items).toFixed(2) : '$0';
            document.getElementById('avgMarkup').textContent = markupCount > 0 ? (markupSum / markupCount).toFixed(1) + '%' : '0%';
        }
        
        function updateInstalledStats() {
            const entries = installedQuantities.length;
            const value = installedQuantities.reduce((s, i) => s + Number(i.extension || 0), 0);
            const dates = [...new Set(installedQuantities.map(i => i.work_date).filter(d => d))];
            const lastDate = dates.sort().pop() || '-';
            
            document.getElementById('installedEntries').textContent = entries;
            document.getElementById('installedValue').textContent = '$' + value.toFixed(2);
            document.getElementById('workDays').textContent = dates.length;
            document.getElementById('lastDate').textContent = lastDate;
        }
        
        function updatePayAppStats() {
            const totalContract = projectBidItems.reduce((s, i) => s + ((Number(i.contract_quantity || 0)) * Number(i.rate || 0)), 0);
            const totalInstalled = projectBidItems.reduce((s, i) => s + (getInstalledQty(i.project_bid_item_id) * Number(i.rate || 0)), 0);
            const percent = totalContract > 0 ? (totalInstalled / totalContract * 100) : 0;
            const balance = totalContract - totalInstalled;
            
            document.getElementById('totalContract').textContent = '$' + totalContract.toFixed(2);
            document.getElementById('totalInstalled').textContent = '$' + totalInstalled.toFixed(2);
            document.getElementById('percentComplete').textContent = percent.toFixed(1) + '%';
            document.getElementById('balance').textContent = '$' + balance.toFixed(2);
        }
        
        function setupEvents() {
            document.getElementById('project').addEventListener('change', function() {
                selectedProjectId = this.value;
                selectedProjectName = this.options[this.selectedIndex].text;
                if (selectedProjectId) {
                    loadProjectData(selectedProjectId);
                    document.getElementById('mainContent').classList.remove('hidden');
                } else {
                    document.getElementById('mainContent').classList.add('hidden');
                }
            });
            
            document.getElementById('searchInput').addEventListener('input', renderBidItems);
            document.getElementById('categoryFilter').addEventListener('change', renderBidItems);
            
            window.addEventListener('beforeunload', function(e) {
                if (Object.keys(modifiedItems).length > 0) { e.preventDefault(); e.returnValue = ''; }
            });
        }
        
        async function deleteItem(id) {
            if (confirm('Delete this item?')) {
                try {
                    await AuthHelper.apiCall(`project-bid-items/${id}`, { method: 'DELETE' });
                    showMessage('Item deleted successfully', 'success');
                    await loadProjectData(selectedProjectId);
                } catch (e) {
                    console.error('Error deleting item:', e);
                    showMessage('Error deleting item. Please check console for details.', 'error');
                }
            }
        }
        
        async function deleteInstalledQty(id) {
            if (confirm('Delete this entry?')) {
                try {
                    await AuthHelper.apiCall(`installed-quantities/${id}`, { method: 'DELETE' });
                    showMessage('Entry deleted successfully', 'success');
                    await loadProjectData(selectedProjectId);
                } catch (e) {
                    console.error('Error deleting entry:', e);
                    showMessage('Error deleting entry. Please check console for details.', 'error');
                }
            }
        }
        
        function showMessage(msg, type) {
            const container = document.getElementById('messageContainer');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = msg;
            container.appendChild(div);
            
            setTimeout(() => div.remove(), 3000);
        }
        
        function exportToCSV(type) {
            let data = [], filename = '';
            
            if (type === 'bid-items') {
                data = projectBidItems.map(i => ({
                    'Item Code': i.item_code,
                    'Item Name': i.item_name,
                    'Category': i.category,
                    'Unit': i.unit,
                    'Rate': i.rate,
                    'Material Cost': i.material_cost,
                    'Markup %': i.material_cost > 0 ? ((i.rate - i.material_cost) / i.material_cost * 100).toFixed(1) : '0',
                    'Contract Qty': i.contract_quantity
                }));
                filename = `${selectedProjectName}_bid_items_${new Date().toISOString().split('T')[0]}.csv`;
            } else if (type === 'installed') {
                data = installedQuantities.map(i => {
                    const bidItem = projectBidItems.find(bi => bi.project_bid_item_id === i.project_bid_item_id);
                    return {
                        'Date': i.work_date,
                        'Item Code': bidItem?.item_code || '',
                        'Item Name': bidItem?.item_name || '',
                        'Quantity': i.quantity,
                        'Unit': bidItem?.unit || '',
                        'Rate': bidItem?.rate || 0,
                        'Extension': (i.quantity * (bidItem?.rate || 0)).toFixed(2),
                        'Notes': i.notes || ''
                    };
                });
                filename = `${selectedProjectName}_installed_${new Date().toISOString().split('T')[0]}.csv`;
            } else if (type === 'pay-app') {
                data = projectBidItems.map(i => {
                    const contract = Number(i.contract_quantity) || 0;
                    const installed = getInstalledQty(i.project_bid_item_id);
                    const rate = Number(i.rate) || 0;
                    return {
                        'Item Code': i.item_code,
                        'Item Name': i.item_name,
                        'Contract Qty': contract.toFixed(2),
                        'Installed Qty': installed.toFixed(2),
                        'Unit': i.unit,
                        'Rate': rate.toFixed(2),
                        'Contract Amount': (contract * rate).toFixed(2),
                        'Installed Amount': (installed * rate).toFixed(2),
                        '% Complete': contract > 0 ? ((installed / contract * 100).toFixed(1)) : '0',
                        'Balance': ((contract - installed) * rate).toFixed(2)
                    };
                });
                filename = `${selectedProjectName}_pay_app_${new Date().toISOString().split('T')[0]}.csv`;
            }
            
            if (data.length === 0) {
                showMessage('No data to export', 'error');
                return;
            }
            
            const csvContent = convertToCSV(data);
            downloadFile(csvContent, filename, 'text/csv');
        }
        
        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const rows = [headers.join(',')];
            
            data.forEach(item => {
                const values = headers.map(h => {
                    const val = item[h];
                    return typeof val === 'string' && val.includes(',') ? `"${val}"` : val;
                });
                rows.push(values.join(','));
            });
            
            return rows.join('\n');
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }
        
        function exportToPDF(type) {
            showMessage('PDF export coming soon', 'error');
        }
    </script>
</body>
</html>

// Configuration
        const API_BASE = '/.netlify/functions/';
        const GOOGLE_MAPS_API_KEY = 'AIzaSyBQq_tXLv0APu8LFfjLogSh4cIqo49yJVg';

        // Global variables
        let currentItemCount = 0;
        let projectBidItems = {};
        let selectedLaborers = new Set();
        let selectedMachines = new Set();
        let map, selectedMarker, selectedLatLng, currentLocationInputId;
        let authToken = null;
        let currentUser = null;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!isAuthenticated()) {
                redirectToLogin();
                return;
            }
            
            loadUserInfo();
            initializeApp();
        });

        // Authentication Helper Functions
        function isAuthenticated() {
            authToken = localStorage.getItem('sessionToken');
            return authToken !== null;
        }

        function redirectToLogin() {
            window.location.href = '/login.html';
        }

        function getUserInfo() {
            return {
                name: localStorage.getItem('userName') || 'User',
                role: localStorage.getItem('userRole') || 'Employee',
                email: localStorage.getItem('userEmail') || 'N/A'
            };
        }

        // API Call Helper
        async function apiCall(endpoint, options = {}) {
            if (!authToken) {
                throw new Error('Not authenticated');
            }

            const url = endpoint.startsWith('http') ? endpoint : `${API_BASE}api/${endpoint}`;
            
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            };

            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };

            const response = await fetch(url, mergedOptions);

            if (response.status === 401) {
                // Token expired, redirect to login
                localStorage.clear();
                redirectToLogin();
                throw new Error('Authentication expired');
            }

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorText}`);
            }

            return await response.json();
        }
        
        // Load user information
        function loadUserInfo() {
            const userInfo = getUserInfo();
            document.getElementById('userName').textContent = userInfo.name;
            document.getElementById('userRole').textContent = userInfo.role;
        }
        
        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                authToken = null;
                currentUser = null;
                redirectToLogin();
            }
        }
        
        // Initialize the application
        function initializeApp() {
            loadMasterData();
            setupEventListeners();
        }

        // Load all master data
        async function loadMasterData() {
            try {
                await Promise.all([
                    loadForemen(),
                    loadLaborers(),
                    loadProjects(),
                    loadEquipment()
                ]);
            } catch (error) {
                console.error('Error loading master data:', error);
                showMessage('Error loading form data. Please refresh the page.', 'error');
            }
        }

        // Load foremen
        async function loadForemen() {
            const loader = document.getElementById('foremanLoader');
            const select = document.getElementById('foreman');
            
            try {
                loader.classList.remove('hidden');
                
                const foremen = await apiCall('foremen');

                foremen.forEach(foreman => {
                    const option = document.createElement('option');
                    option.value = foreman.id;
                    option.textContent = foreman.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading foremen:', error);
                showMessage('Error loading foremen data.', 'error');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Load laborers
        async function loadLaborers() {
            const loader = document.getElementById('laborerLoader');
            const container = document.getElementById('laborersContainer');
            
            try {
                const laborers = await apiCall('laborers');

                container.innerHTML = '';
                laborers.forEach(laborer => {
                    const item = createMultiSelectItem(laborer.id, laborer.name, 'laborer');
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading laborers:', error);
                container.innerHTML = '<div style="padding: 15px; color: #dc3545;">Error loading laborers</div>';
            }
        }

        // Load projects
        async function loadProjects() {
            const loader = document.getElementById('projectLoader');
            const select = document.getElementById('project');
            
            try {
                loader.classList.remove('hidden');
                
                const projects = await apiCall('projects');

                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading projects:', error);
                showMessage('Error loading projects data.', 'error');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Load equipment by type
        async function loadEquipment() {
            try {
                await Promise.all([
                    loadEquipmentByType('CREW TRUCK', 'truck', 'truckLoader'),
                    loadEquipmentByType('TRAILER', 'trailer', 'trailerLoader'),
                    loadMachines()
                ]);
            } catch (error) {
                console.error('Error loading equipment:', error);
            }
        }

        async function loadEquipmentByType(type, selectId, loaderId) {
            const loader = document.getElementById(loaderId);
            const select = document.getElementById(selectId);
            
            try {
                loader.classList.remove('hidden');
                
                const equipment = await apiCall(`equipment?type=${encodeURIComponent(type)}`);

                equipment.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error(`Error loading ${type}:`, error);
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function loadMachines() {
            const loader = document.getElementById('machineLoader');
            const container = document.getElementById('machinesContainer');
            
            try {
                const machines = await apiCall('equipment?type=MACHINE');

                container.innerHTML = '';
                machines.forEach(machine => {
                    const item = createMultiSelectItem(machine.id, machine.name, 'machine');
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading machines:', error);
                container.innerHTML = '<div style="padding: 15px; color: #dc3545;">Error loading machines</div>';
            }
        }

        // Load project bid items using the consolidated endpoint
        async function loadProjectBidItems(projectId) {
            if (!projectId) return;
            try {
                projectBidItems = await AuthHelper.apiCall('project-bid-items?project_id=' + projectId);
                renderBidItemsTable();
                updateStats();
                document.getElementById('bidItemsSection').classList.remove('hidden');
            } catch (error) {
                showMessage('Error loading project bid items.', 'error');
            }
        }

        // Create multi-select item
        function createMultiSelectItem(id, name, type) {
            const item = document.createElement('div');
            item.className = 'multi-select-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `${type}_${id}`;
            checkbox.value = id;
            checkbox.addEventListener('change', () => updateSelectedItems(type));
            
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = name;
            
            item.appendChild(checkbox);
            item.appendChild(label);
            
            return item;
        }

        // Update selected items display
        function updateSelectedItems(type) {
            const container = type === 'laborer' ? selectedLaborers : selectedMachines;
            const displayId = type === 'laborer' ? 'selectedLaborers' : 'selectedMachines';
            
            container.clear();
            
            document.querySelectorAll(`input[id^="${type}_"]:checked`).forEach(checkbox => {
                const label = document.querySelector(`label[for="${checkbox.id}"]`);
                container.add({
                    id: checkbox.value,
                    name: label.textContent
                });
            });
            
            updateSelectedDisplay(displayId, container, type);
        }

        function updateSelectedDisplay(displayId, selectedSet, type) {
            const display = document.getElementById(displayId);
            
            if (selectedSet.size === 0) {
                display.className = 'selected-items empty';
                display.innerHTML = type === 'laborer' ? 'No crew members selected' : 'No machines selected';
            } else {
                display.className = 'selected-items';
                display.innerHTML = Array.from(selectedSet).map(item => 
                    `<span class="selected-tag">
                        ${item.name}
                        <button type="button" class="remove" onclick="removeSelected('${type}', '${item.id}')">√ó</button>
                    </span>`
                ).join('');
            }
        }

        function removeSelected(type, id) {
            const checkbox = document.getElementById(`${type}_${id}`);
            if (checkbox) {
                checkbox.checked = false;
                updateSelectedItems(type);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('project').addEventListener('change', function() {
                if (this.value) {
                    loadProjectBidItems(this.value);
                }
            });

            document.getElementById('billableWork').addEventListener('change', handleBillableWorkChange);
            document.getElementById('addItemBtn').addEventListener('click', addItemSection);
            document.getElementById('dwrForm').addEventListener('submit', handleSubmit);
        }

        // Handle billable work selection
        function handleBillableWorkChange() {
            const value = document.getElementById('billableWork').value;
            const itemsSection = document.getElementById('itemsSection');
            
            if (value === 'Yes') {
                itemsSection.classList.remove('hidden');
                if (document.querySelectorAll('.item-section').length === 0) {
                    addItemSection();
                }
            } else if (value === 'Maybe') {
                document.getElementById('maybeModal').classList.add('show');
            } else if (value === 'No') {
                itemsSection.classList.add('hidden');
            } else {
                itemsSection.classList.add('hidden');
            }
        }

        function closeMaybeModal() {
            document.getElementById('maybeModal').classList.remove('show');
        }

        function continueMaybe() {
            const explanation = document.getElementById('maybeExplanation').value.trim();
            if (!explanation) {
                alert('Please provide an explanation.');
                return;
            }
            
            closeMaybeModal();
            document.getElementById('itemsSection').classList.remove('hidden');
            if (document.querySelectorAll('.item-section').length === 0) {
                addItemSection();
            }
        }

        // Add item section (keeping all the existing HTML generation)
        function addItemSection() {
            currentItemCount++;
            const container = document.getElementById('itemsContainer');
            
            const itemSection = document.createElement('div');
            itemSection.className = 'item-section';
            itemSection.dataset.itemIndex = currentItemCount;
            
            itemSection.innerHTML = `
                <div class="item-header">
                    <div class="item-title">Item #${currentItemCount}</div>
                    <button type="button" class="btn btn-danger" onclick="removeItemSection(${currentItemCount})">
                        üóëÔ∏è Remove
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="item_${currentItemCount}">What item did you perform?</label>
                    <select id="item_${currentItemCount}" required>
                        <option value="">-- Select Item --</option>
                    </select>
                    <div id="bidInfo_${currentItemCount}" class="bid-item-info">
                        <div class="bid-info-row">
                            <span class="bid-info-label">Rate:</span>
                            <span class="bid-info-value" id="rate_${currentItemCount}">$0.00</span>
                        </div>
                        <div class="bid-info-row">
                            <span class="bid-info-label">Cost:</span>
                            <span class="bid-info-value" id="cost_${currentItemCount}">$0.00</span>
                        </div>
                        <div class="bid-info-row">
                            <span class="bid-info-label">Markup:</span>
                            <span class="bid-info-value" id="markup_${currentItemCount}">0.00%</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="quantity_${currentItemCount}">How many <span class="unit-label">units</span> did you install at this location?</label>
                    <input type="number" id="quantity_${currentItemCount}" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="location_${currentItemCount}">At what location was this item performed?</label>
                    <div class="location-container">
                        <input type="text" id="location_${currentItemCount}" required placeholder="Enter location or use map">
                        <button type="button" class="map-btn" onclick="openMapModal(${currentItemCount})">
                            üìç Map
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="duration_${currentItemCount}">Duration (hours):</label>
                    <select id="duration_${currentItemCount}" required>
                        <option value="">-- Select Duration --</option>
                        <option value="0.25">15 minutes (0.25 hours)</option>
                        <option value="0.5">30 minutes (0.5 hours)</option>
                        <option value="0.75">45 minutes (0.75 hours)</option>
                        <option value="1">1 hour</option>
                        <option value="1.25">1 hour 15 minutes</option>
                        <option value="1.5">1 hour 30 minutes</option>
                        <option value="1.75">1 hour 45 minutes</option>
                        <option value="2">2 hours</option>
                        <option value="2.25">2 hours 15 minutes</option>
                        <option value="2.5">2 hours 30 minutes</option>
                        <option value="2.75">2 hours 45 minutes</option>
                        <option value="3">3 hours</option>
                        <option value="3.25">3 hours 15 minutes</option>
                        <option value="3.5">3 hours 30 minutes</option>
                        <option value="3.75">3 hours 45 minutes</option>
                        <option value="4">4 hours</option>
                        <option value="4.25">4 hours 15 minutes</option>
                        <option value="4.5">4 hours 30 minutes</option>
                        <option value="4.75">4 hours 45 minutes</option>
                        <option value="5">5 hours</option>
                        <option value="5.25">5 hours 15 minutes</option>
                        <option value="5.5">5 hours 30 minutes</option>
                        <option value="5.75">5 hours 45 minutes</option>
                        <option value="6">6 hours</option>
                        <option value="6.25">6 hours 15 minutes</option>
                        <option value="6.5">6 hours 30 minutes</option>
                        <option value="6.75">6 hours 45 minutes</option>
                        <option value="7">7 hours</option>
                        <option value="7.25">7 hours 15 minutes</option>
                        <option value="7.5">7 hours 30 minutes</option>
                        <option value="7.75">7 hours 45 minutes</option>
                        <option value="8">8 hours</option>
                        <option value="8.25">8 hours 15 minutes</option>
                        <option value="8.5">8 hours 30 minutes</option>
                        <option value="8.75">8 hours 45 minutes</option>
                        <option value="9">9 hours</option>
                        <option value="9.25">9 hours 15 minutes</option>
                        <option value="9.5">9 hours 30 minutes</option>
                        <option value="9.75">9 hours 45 minutes</option>
                        <option value="10">10 hours</option>
                        <option value="10.25">10 hours 15 minutes</option>
                        <option value="10.5">10 hours 30 minutes</option>
                        <option value="10.75">10 hours 45 minutes</option>
                        <option value="11">11 hours</option>
                        <option value="11.25">11 hours 15 minutes</option>
                        <option value="11.5">11 hours 30 minutes</option>
                        <option value="11.75">11 hours 45 minutes</option>
                        <option value="12">12 hours</option>
                    </select>
                </div>

                <div id="lineTotals_${currentItemCount}" class="line-totals">
                    <div class="total-row">
                        <span class="total-label">Line Revenue:</span>
                        <span class="total-value revenue" id="lineRevenue_${currentItemCount}">$0.00</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">Line Cost:</span>
                        <span class="total-value cost" id="lineCost_${currentItemCount}">$0.00</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">Line Profit:</span>
                        <span class="total-value profit" id="lineProfit_${currentItemCount}">$0.00</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notes_${currentItemCount}">Additional Notes (Optional):</label>
                    <textarea id="notes_${currentItemCount}" rows="3" placeholder="Enter any additional details..."></textarea>
                </div>
            `;
            
            container.appendChild(itemSection);
            updateAllItemDropdowns();
            
            // Add event listeners for item selection and quantity
            document.getElementById(`item_${currentItemCount}`).addEventListener('change', function() {
                updateItemInfo(currentItemCount);
            });
            
            document.getElementById(`quantity_${currentItemCount}`).addEventListener('input', function() {
                updateLineTotals(currentItemCount);
            });
        }

        function removeItemSection(index) {
            const section = document.querySelector(`[data-item-index="${index}"]`);
            if (section) {
                section.remove();
            }
            
            // If no items left, add one
            if (document.querySelectorAll('.item-section').length === 0) {
                addItemSection();
            }
        }

        // Update all item dropdowns
        function updateAllItemDropdowns() {
            const projectId = document.getElementById('project').value;
            if (!projectId) return;

            document.querySelectorAll('.item-section').forEach(section => {
                const index = section.dataset.itemIndex;
                const select = document.getElementById(`item_${index}`);
                const currentValue = select.value;
                
                // Clear existing options except first
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                if (projectBidItemsMap[projectId]) {
                    // Add bid items
                    projectBidItemsMap[projectId].forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.item_name;
                        option.textContent = `${item.item_code} - ${item.item_name}`;
                        option.dataset.unit = item.unit;
                        option.dataset.bidItemId = item.bid_item_id;
                        option.dataset.projectBidItemId = item.project_bid_item_id;
                        option.dataset.rate = item.rate;
                        option.dataset.cost = item.current_cost;
                        option.dataset.markup = item.markup_percentage || 0;
                        select.appendChild(option);
                    });
                }
                
                // Restore selection if exists and still valid
                if (currentValue) {
                    const foundOption = Array.from(select.options).find(opt => opt.value === currentValue);
                    if (foundOption) {
                        select.value = currentValue;
                    }
                }
                
                updateItemInfo(index);
            });
        }

        function updateItemInfo(index) {
            const select = document.getElementById(`item_${index}`);
            const unitLabel = document.querySelector(`[data-item-index="${index}"] .unit-label`);
            const bidInfo = document.getElementById(`bidInfo_${index}`);
            const lineTotals = document.getElementById(`lineTotals_${index}`);
            
            if (select.selectedIndex > 0) {
                const option = select.options[select.selectedIndex];
                const unit = option.dataset.unit || 'units';
                unitLabel.textContent = unit;
                
                // Show bid item info
                bidInfo.classList.add('show');
                lineTotals.classList.add('show');
                
                document.getElementById(`rate_${index}`).textContent = 
                    `$${parseFloat(option.dataset.rate || 0).toFixed(2)}`;
                document.getElementById(`cost_${index}`).textContent = 
                    `$${parseFloat(option.dataset.cost || 0).toFixed(2)}`;
                document.getElementById(`markup_${index}`).textContent = 
                    `${parseFloat(option.dataset.markup || 0).toFixed(2)}%`;
                
                updateLineTotals(index);
            } else {
                unitLabel.textContent = 'units';
                bidInfo.classList.remove('show');
                lineTotals.classList.remove('show');
            }
        }

        function updateLineTotals(index) {
            const select = document.getElementById(`item_${index}`);
            const quantityInput = document.getElementById(`quantity_${index}`);
            
            if (select.selectedIndex > 0 && quantityInput.value) {
                const option = select.options[select.selectedIndex];
                const quantity = parseFloat(quantityInput.value) || 0;
                
                const rate = parseFloat(option.dataset.rate || 0);
                const cost = parseFloat(option.dataset.cost || 0);
                
                const revenue = quantity * rate;
                const totalCost = quantity * cost;
                const profit = revenue - totalCost;
                
                document.getElementById(`lineRevenue_${index}`).textContent = `$${revenue.toFixed(2)}`;
                document.getElementById(`lineCost_${index}`).textContent = `$${totalCost.toFixed(2)}`;
                document.getElementById(`lineProfit_${index}`).textContent = `$${profit.toFixed(2)}`;
            }
        }

        // Map functionality
        function openMapModal(itemIndex) {
            currentLocationInputId = `location_${itemIndex}`;
            document.getElementById('mapModal').classList.add('show');
            
            // Initialize map if not already done
            if (!map) {
                initializeMap();
            }
            
            resetMapSelection();
        }

        function closeMapModal() {
            document.getElementById('mapModal').classList.remove('show');
        }

        function initializeMap() {
            // Default to center of USA
            const defaultLocation = { lat: 39.8283, lng: -98.5795 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 10,
                center: defaultLocation,
                mapTypeId: google.maps.MapTypeId.HYBRID
            });
            
            map.addListener('click', function(event) {
                selectLocation(event.latLng);
            });
            
            // Try to get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(userLocation);
                    map.setZoom(15);
                });
            }
        }

        function selectLocation(latLng) {
            selectedLatLng = latLng;
            
            // Remove previous marker
            if (selectedMarker) {
                selectedMarker.setMap(null);
            }
            
            // Add new marker
            selectedMarker = new google.maps.Marker({
                position: latLng,
                map: map,
                title: 'Selected Location'
            });
            
            // Show coordinates
            const lat = latLng.lat().toFixed(6);
            const lng = latLng.lng().toFixed(6);
            document.getElementById('coordinatesDisplay').innerHTML = 
                `<strong>Selected Coordinates:</strong><br>Latitude: ${lat}<br>Longitude: ${lng}`;
            document.getElementById('coordinatesDisplay').classList.remove('hidden');
            document.getElementById('confirmLocationBtn').disabled = false;
        }

        function confirmLocation() {
            if (selectedLatLng && currentLocationInputId) {
                const lat = selectedLatLng.lat().toFixed(6);
                const lng = selectedLatLng.lng().toFixed(6);
                document.getElementById(currentLocationInputId).value = `${lat}, ${lng}`;
                closeMapModal();
            }
        }

        function resetMapSelection() {
            selectedLatLng = null;
            if (selectedMarker) {
                selectedMarker.setMap(null);
                selectedMarker = null;
            }
            document.getElementById('coordinatesDisplay').classList.add('hidden');
            document.getElementById('confirmLocationBtn').disabled = true;
        }

        // Form submission
        async function handleSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitLoader = document.getElementById('submitLoader');
            
            try {
                submitBtn.disabled = true;
                submitLoader.classList.remove('hidden');
                
                // Collect form data
                const formData = collectFormData();
                
                // Validate form data
                if (!validateFormData(formData)) {
                    return;
                }
                
                // Submit to database using direct API call
                const result = await apiCall('submit-dwr', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                if (result.success) {
                    showMessage('Daily Work Report submitted successfully!', 'success');
                    resetForm();
                } else {
                    throw new Error(result.error || 'Unknown error occurred');
                }
                
            } catch (error) {
                console.error('Error submitting form:', error);
                showMessage('Error submitting form: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitLoader.classList.add('hidden');
            }
        }

        function collectFormData() {
            const billableWork = document.getElementById('billableWork').value;
            
            const formData = {
                work_date: document.getElementById('workDate').value,
                foreman_id: document.getElementById('foreman').value,
                project_id: document.getElementById('project').value,
                arrival_time: document.getElementById('arrivalTime').value,
                departure_time: document.getElementById('departureTime').value,
                truck_id: document.getElementById('truck').value || null,
                trailer_id: document.getElementById('trailer').value || null,
                billable_work: billableWork,
                maybe_explanation: billableWork === 'Maybe' ? document.getElementById('maybeExplanation').value : null,
                per_diem: document.getElementById('perDiem').value === 'true',
                laborers: Array.from(selectedLaborers).map(l => l.id),
                machines: Array.from(selectedMachines).map(m => m.id),
                items: []
            };
            
            // Collect items if billable work
            if (billableWork === 'Yes' || billableWork === 'Maybe') {
                const itemSections = document.querySelectorAll('.item-section');
                itemSections.forEach((section, index) => {
                    const itemIndex = section.dataset.itemIndex;
                    const itemSelect = document.getElementById(`item_${itemIndex}`);
                    
                    if (itemSelect.value) {
                        const option = itemSelect.options[itemSelect.selectedIndex];
                        const locationValue = document.getElementById(`location_${itemIndex}`).value;
                        
                        // Parse coordinates if they exist
                        let latitude = null, longitude = null;
                        if (locationValue.includes(',')) {
                            const coords = locationValue.split(',');
                            if (coords.length === 2) {
                                const lat = parseFloat(coords[0].trim());
                                const lng = parseFloat(coords[1].trim());
                                if (!isNaN(lat) && !isNaN(lng)) {
                                    latitude = lat;
                                    longitude = lng;
                                }
                            }
                        }
                        
                        const itemData = {
                            item_name: itemSelect.value,
                            quantity: parseFloat(document.getElementById(`quantity_${itemIndex}`).value),
                            unit: option.dataset.unit || 'units',
                            location_description: locationValue,
                            latitude: latitude,
                            longitude: longitude,
                            duration_hours: parseFloat(document.getElementById(`duration_${itemIndex}`).value),
                            notes: document.getElementById(`notes_${itemIndex}`).value || null,
                            bid_item_id: option.dataset.bidItemId,
                            project_bid_item_id: option.dataset.projectBidItemId
                        };

                        formData.items.push(itemData);
                    }
                });
            }
            
            return formData;
        }

        function validateFormData(formData) {
            const required = ['work_date', 'foreman_id', 'project_id', 'arrival_time', 'departure_time', 'billable_work'];
            
            for (const field of required) {
                if (!formData[field]) {
                    showMessage(`Please fill in all required fields.`, 'error');
                    return false;
                }
            }
            
            if (formData.billable_work === 'Maybe' && !formData.maybe_explanation) {
                showMessage('Please provide an explanation for "Maybe" billable work.', 'error');
                return false;
            }
            
            if ((formData.billable_work === 'Yes' || formData.billable_work === 'Maybe') && formData.items.length === 0) {
                showMessage('Please add at least one work item.', 'error');
                return false;
            }
            
            return true;
        }

        function resetForm() {
            document.getElementById('dwrForm').reset();
            document.getElementById('itemsSection').classList.add('hidden');
            document.getElementById('itemsContainer').innerHTML = '';
            currentItemCount = 0;
            selectedLaborers.clear();
            selectedMachines.clear();
            updateSelectedDisplay('selectedLaborers', selectedLaborers, 'laborer');
            updateSelectedDisplay('selectedMachines', selectedMachines, 'machine');
            
            // Uncheck all checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function showMessage(message, type) {
            const resultDiv = document.getElementById('resultMessage');
            resultDiv.className = `alert alert-${type}`;
            resultDiv.textContent = message;
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                    resultDiv.className = '';
                }, 5000);
            }
        }

        // Load Google Maps API
        function loadGoogleMaps() {
            if (GOOGLE_MAPS_API_KEY && GOOGLE_MAPS_API_KEY !== 'YOUR_GOOGLE_MAPS_API_KEY') {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initGoogleMaps`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
            }
        }

        window.initGoogleMaps = function() {
            console.log('Google Maps API loaded');
        };

        // Load maps when page loads
        loadGoogleMaps();
    </script>
</body>
</html>
